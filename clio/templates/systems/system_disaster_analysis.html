<!-- templates/systems/system_disaster_analysis.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}Disaster Analysis for {{ system.name }} - Clio{% endblock %}

{% block extra_css %}
<style>
    /* Main Container Styles */
    .disaster-analysis-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    /* Impact Visualization Styles */
    .impact-visualization {
        position: relative;
        width: 100%;
        height: 600px;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        background-color: white;
        overflow: hidden;
    }
    
    .controls-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
        background-color: #f8fafc;
    }
    
    .controls-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .controls-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .viz-container {
        width: 100%;
        height: calc(100% - 60px);
        overflow: auto;
    }
    
    /* Impact Summary Styles */
    .impact-summary {
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .impact-summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .impact-summary-content {
        padding: 1rem;
    }
    
    .impact-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .stat-card {
        flex: 1 1 200px;
        background-color: #f8fafc;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
    }
    
    .stat-number {
        font-size: 1.875rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        color: #64748b;
        font-size: 0.875rem;
    }
    
    .system-list {
        margin-top: 1rem;
    }
    
    .system-list-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }
    
    .system-list-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
    }
    
    .system-list-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .system-list-table th {
        background-color: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .system-list-table th, .system-list-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
    }
    
    .system-list-table tr:last-child td {
        border-bottom: none;
    }
    
    /* Recovery Steps Styles */
    .recovery-steps {
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .recovery-steps-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .recovery-steps-content {
        padding: 1rem;
    }
    
    .steps-container {
        margin-top: 1rem;
    }
    
    .step-item {
        display: flex;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        margin-bottom: 0.75rem;
        background-color: white;
        overflow: hidden;
    }
    
    .step-order {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 3rem;
        background-color: #f8fafc;
        border-right: 1px solid #e2e8f0;
        font-weight: 600;
        color: #64748b;
    }
    
    .step-content {
        flex: 1;
        padding: 1rem;
    }
    
    .step-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .step-title {
        font-weight: 600;
    }
    
    .step-metadata {
        font-size: 0.875rem;
        color: #64748b;
    }
    
    .step-description {
        margin-bottom: 0.5rem;
        color: #334155;
    }
    
    .step-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    /* Node and Edge Styles for Graph */
    .node {
        stroke-width: 2px;
        cursor: pointer;
    }
    
    .node text {
        font-size: 12px;
        fill: #1e293b;
        pointer-events: none;
    }
    
    .node-bg {
        fill: white;
        stroke: #e2e8f0;
        stroke-width: 1px;
        rx: 4;
        ry: 4;
    }
    
    .node:hover .node-bg {
        stroke: #94a3b8;
        stroke-width: 2px;
    }
    
    .node-system {
        fill: var(--color);
    }
    
    .node.selected .node-bg {
        stroke: #3b82f6;
        stroke-width: 3px;
    }
    
    .node.affected .node-bg {
        stroke: #ef4444;
        stroke-width: 2px;
    }
    
    .node.source .node-bg {
        stroke: #ef4444;
        stroke-width: 3px;
    }
    
    .edge {
        stroke: #cbd5e1;
        stroke-width: 1.5px;
        fill: none;
    }
    
    .edge.affected {
        stroke: #ef4444;
        stroke-width: 2px;
    }
    
    .edge-arrow {
        fill: #cbd5e1;
    }
    
    .edge.affected .edge-arrow {
        fill: #ef4444;
    }
    
    /* Form Styles */
    .recovery-form-container {
        margin-top: 1rem;
    }
    
    .recovery-form {
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8fafc;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.375rem;
        font-weight: 500;
    }
    
    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #cbd5e1;
        border-radius: 0.25rem;
        background-color: white;
    }
    
    textarea.form-control {
        min-height: 100px;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    /* Button Styles */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .btn-icon {
        padding: 0.5rem;
    }
    
    .btn-primary {
        background-color: #3b82f6;
        color: white;
        border: 1px solid #2563eb;
    }
    
    .btn-primary:hover {
        background-color: #2563eb;
    }
    
    .btn-secondary {
        background-color: white;
        color: #0f172a;
        border: 1px solid #cbd5e1;
    }
    
    .btn-secondary:hover {
        background-color: #f8fafc;
    }
    
    .btn-danger {
        background-color: #ef4444;
        color: white;
        border: 1px solid #dc2626;
    }
    
    .btn-danger:hover {
        background-color: #dc2626;
    }
    
    .btn-success {
        background-color: #10b981;
        color: white;
        border: 1px solid #059669;
    }
    
    .btn-success:hover {
        background-color: #059669;
    }
    
    /* Badge Styles */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    /* Modal Styles */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
    }
    
    .modal-backdrop.show {
        opacity: 1;
        visibility: visible;
    }
    
    .modal {
        width: 100%;
        max-width: 500px;
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transform: scale(0.95);
        opacity: 0;
        transition: transform 0.2s, opacity 0.2s;
    }
    
    .modal-backdrop.show .modal {
        transform: scale(1);
        opacity: 1;
    }
    
    .modal-header {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .modal-title {
        font-weight: 600;
        font-size: 1.125rem;
    }
    
    .modal-close {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.25rem;
        color: #64748b;
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .modal-footer {
        padding: 1rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    /* Animation for affected systems */
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    .node.source .node-system {
        animation: pulse 2s infinite;
    }
    
    /* Tooltip Style */
    .tooltip {
        position: absolute;
        background-color: rgba(15, 23, 42, 0.9);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        pointer-events: none;
        z-index: 100;
        max-width: 300px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transform: translate(-50%, -100%);
        margin-top: -10px;
    }
    
    .tooltip::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 50%;
        margin-left: -5px;
        border-width: 5px 5px 0;
        border-style: solid;
        border-color: rgba(15, 23, 42, 0.9) transparent transparent transparent;
    }
    
    /* Legend Style */
    .legend-container {
        position: absolute;
        top: 70px;
        right: 10px;
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 0.75rem;
        z-index: 20;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .legend-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.375rem;
        font-size: 0.75rem;
    }
    
    .legend-item:last-child {
        margin-bottom: 0;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        margin-right: 0.5rem;
        border-radius: 0.25rem;
        border: 1px solid #e2e8f0;
    }
    
    /* Loading Indicator */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 30;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 0.75rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block page_header %}
<div class="md:flex md:items-center md:justify-between">
    <div class="flex-1 min-w-0">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
            Disaster Analysis for {{ system.name }}
        </h2>
    </div>
    <div class="mt-4 flex md:mt-0 md:ml-4">
        <a href="{% url 'systems:detail' system.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Back to System Details
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="disaster-analysis-container">
    <!-- System Overview -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="sm:col-span-2">
                    <div class="mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">System Overview</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">Key information about the system</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Name</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ system.name }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Category</dt>
                            <dd class="mt-1 text-sm">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background-color: {{ system.category.color }}; color: {{ system.category.text_color }}">
                                    {{ system.category.name }}
                                </span>
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Status</dt>
                            <dd class="mt-1 text-sm">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background-color: {{ system.status.color }}; color: {{ system.status.text_color }}">
                                    {{ system.status.name }}
                                </span>
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Vendor</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ system.vendor|default:"Not specified" }}</dd>
                        </div>
                        {% if system.hosting_system %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Hosting System</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <a href="{% url 'systems:detail' system.hosting_system.pk %}" class="text-blue-600 hover:text-blue-900">
                                    {{ system.hosting_system.name }}
                                </a>
                            </dd>
                        </div>
                        {% endif %}
                        {% if system.sso_system %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">SSO System</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <a href="{% url 'systems:detail' system.sso_system.pk %}" class="text-blue-600 hover:text-blue-900">
                                    {{ system.sso_system.name }}
                                </a>
                            </dd>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <div class="mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Administrators</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">People responsible for this system</p>
                    </div>
                    {% if administrators %}
                    <ul class="divide-y divide-gray-200">
                        {% for admin in administrators %}
                        <li class="py-2 flex items-center">
                            <div class="flex-shrink-0">
                                <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-500">
                                    {{ admin.user.first_name|first|upper }}{{ admin.user.last_name|first|upper }}
                                </span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">{{ admin.user.get_full_name }}</p>
                                {% if admin.is_primary %}
                                <p class="text-xs text-blue-700">Primary Administrator</p>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-sm text-gray-500">No administrators assigned</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Impact Visualization -->
    <div class="impact-visualization">
        <div class="controls-container">
            <div class="controls-left">
                <h3 class="text-lg font-medium">Downstream Impact Analysis</h3>
                <div>
                    <label for="depth-control" class="text-sm text-gray-600 mr-2">Impact Depth:</label>
                    <select id="depth-control" class="text-sm border border-gray-300 rounded px-2 py-1">
                        <option value="1">Direct Dependencies</option>
                        <option value="2">Two Levels</option>
                        <option value="3">Three Levels</option>
                        <option value="0" selected>All Levels</option>
                    </select>
                </div>
            </div>
            <div class="controls-right">
                <button id="reset-zoom" class="btn btn-sm btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 16 16">
                        <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                        <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                    </svg>
                    Reset View
                </button>
                <button id="zoom-in" class="btn btn-sm btn-icon btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 7.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V12a.5.5 0 0 1-1 0v-1.5H6a.5.5 0 0 1 0-1h1.5V8a.5.5 0 0 1 .5-.5z"/>
                        <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/>
                    </svg>
                </button>
                <button id="zoom-out" class="btn btn-sm btn-icon btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 7.5a.5.5 0 0 1 .5.5v1.5h1.5a.5.5 0 0 1 0 1h-3.5a.5.5 0 0 1 0-1H8V8a.5.5 0 0 1 .5-.5z"/>
                        <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="viz-container" id="impact-graph"></div>
        
        <!-- Legend for visualization -->
        <div class="legend-container">
            <div class="legend-title">Legend</div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ef4444;"></div>
                <span>Source System (Outage)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f87171;"></div>
                <span>Directly Affected Systems</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fdba74;"></div>
                <span>Indirectly Affected Systems</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #cbd5e1;"></div>
                <span>Unaffected Systems</span>
            </div>
        </div>
        
        <!-- Loading indicator -->
        <div class="loading-overlay" id="viz-loading">
            <div class="spinner"></div>
            <div class="text-lg font-medium text-gray-700">Analyzing dependencies...</div>
        </div>
    </div>

    <!-- Impact Summary -->
    <div class="impact-summary">
        <div class="impact-summary-header">
            <h3 class="text-lg font-medium">Impact Summary</h3>
            <a href="#" id="export-report" class="btn btn-sm btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Export Report
            </a>
        </div>
        <div class="impact-summary-content">
            <div class="impact-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-affected">-</div>
                    <div class="stat-label">Total Affected Systems</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="direct-affected">-</div>
                    <div class="stat-label">Directly Affected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="indirect-affected">-</div>
                    <div class="stat-label">Indirectly Affected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="max-depth">-</div>
                    <div class="stat-label">Maximum Impact Depth</div>
                </div>
            </div>
            
            <div class="system-list">
                <h4 class="system-list-title">Affected Systems</h4>
                <div class="system-list-container">
                    <table class="system-list-table" id="affected-systems-table">
                        <thead>
                            <tr>
                                <th width="40%">System Name</th>
                                <th width="25%">Category</th>
                                <th width="20%">Vendor</th>
                                <th width="15%">Impact Level</th>
                            </tr>
                        </thead>
                        <tbody id="affected-systems-body">
                            <tr>
                                <td colspan="4" class="text-center py-4 text-gray-500">Loading affected systems...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recovery Steps -->
    <div class="recovery-steps">
        <div class="recovery-steps-header">
            <h3 class="text-lg font-medium">Disaster Recovery Steps</h3>
            <button id="add-step-btn" class="btn btn-sm btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Add Step
            </button>
        </div>
        <div class="recovery-steps-content">
            {% if recovery_steps %}
            <div class="steps-container" id="recovery-steps-container">
                {% for step in recovery_steps %}
                <div class="step-item" id="step-{{ step.id }}" data-order="{{ step.order }}">
                    <div class="step-order">{{ step.order }}</div>
                    <div class="step-content">
                        <div class="step-header">
                            <h4 class="step-title">{{ step.title }}</h4>
                            <div class="step-metadata">
                                {% if step.estimated_time %}
                                <span class="badge" style="background-color: #e0f2fe; color: #0369a1">
                                    Est. Time: {{ step.estimated_time }}
                                </span>
                                {% endif %}
                                {% if step.responsible_team %}
                                <span class="ml-2 text-gray-600">Resp: {{ step.responsible_team }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="step-description">{{ step.description }}</div>
                        <div class="step-actions">
                            {% if not forloop.first %}
                            <button class="btn btn-sm btn-icon btn-secondary move-step" data-direction="up" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>
                                </svg>
                            </button>
                            {% endif %}
                            {% if not forloop.last %}
                            <button class="btn btn-sm btn-icon btn-secondary move-step" data-direction="down" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>
                                </svg>
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-icon btn-secondary edit-step" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-icon btn-danger delete-step" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="mx-auto mb-4 text-gray-400" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                </svg>
                <p class="text-lg">No recovery steps defined yet</p>
                <p class="mt-2">Click the "Add Step" button to create your disaster recovery plan</p>
            </div>
            {% endif %}
            
            <!-- Recovery step form (initially hidden) -->
            <div class="recovery-form-container" id="recovery-form-container" style="display: none;">
                <form id="recovery-step-form" method="post" action="{% url 'systems:save_recovery_step' system.pk %}" class="recovery-form">
                    {% csrf_token %}
                    <input type="hidden" name="step_id" id="step_id">
                    <div class="form-group">
                        <label for="title" class="form-label">Step Title</label>
                        <input type="text" id="title" name="title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="description" class="form-label">Description</label>
                        <textarea id="description" name="description" class="form-control" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="responsible_team" class="form-label">Responsible Team/Person</label>
                        <input type="text" id="responsible_team" name="responsible_team" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="estimated_time" class="form-label">Estimated Time to Complete</label>
                        <input type="text" id="estimated_time" name="estimated_time" class="form-control" placeholder="e.g. 30 minutes, 2 hours">
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancel-step-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Step</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for step deletion confirmation -->
<div class="modal-backdrop" id="delete-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Deletion</h3>
            <button type="button" class="modal-close" id="close-delete-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this recovery step? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-delete">Cancel</button>
            <form method="post" id="delete-step-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Constants and global variables - passed from Django
    var sourceSystemId = {{ system.id }};
    var sourceSystemName = "{{ system.name }}";
    var systemDetailUrl = "{% url 'systems:detail' 0 %}";
    var affectedSystemsData = [];
    var graphData = {
        nodes: [],
        links: []
    };
    
    // Initialize visualization
    initializeVisualization();
    
    // =============================
    // Visualization Functions
    // =============================
    function initializeVisualization() {
        // Fetch relationship data using the existing API endpoint
        fetch("{% url 'systems:relationship_data' %}")
            .then(response => response.json())
            .then(data => {
                // Process the data and build the impact graph
                processRelationshipData(data);
            })
            .catch(error => {
                console.error("Error loading relationship data:", error);
                document.getElementById('viz-loading').style.display = 'none';
                document.getElementById('impact-graph').innerHTML = 
                    '<div class="flex items-center justify-center h-full">' +
                    '<div class="text-center p-6 bg-red-50 rounded-lg">' +
                    '<h3 class="text-lg font-medium text-red-800">Error Loading Data</h3>' +
                    '<p class="mt-2 text-red-600">Could not load relationship data. Please try again later.</p>' +
                    '</div>' +
                    '</div>';
            });
    }
    
    function processRelationshipData(data) {
        // Extract systems and links
        var allSystems = data.systems;
        var allLinks = data.links;
        
        // Find the source system
        var sourceSystem = allSystems.find(function(system) {
            return system.id === sourceSystemId;
        });
        
        if (!sourceSystem) {
            console.error("Source system not found in the data");
            document.getElementById('viz-loading').style.display = 'none';
            return;
        }
        
        // First, build a dependency graph to track affected systems
        var dependencyGraph = buildDependencyGraph(allSystems, allLinks);
        
        // Then, determine all affected systems, with their impact level
        affectedSystemsData = determineAffectedSystems(dependencyGraph, sourceSystemId);
        
        // Build graph data structure for visualization
        graphData = buildGraphData(allSystems, allLinks, affectedSystemsData, sourceSystemId);
        
        // Render the graph
        renderGraph(graphData);
        
        // Populate impact summary
        populateImpactSummary(affectedSystemsData);
        
        // Hide loading indicator
        document.getElementById('viz-loading').style.display = 'none';
    }
    
    function buildDependencyGraph(systems, links) {
        // Create a graph representation to find affected systems
        var graph = {};
        
        // Initialize the graph with all systems
        systems.forEach(function(system) {
            graph[system.id] = {
                id: system.id,
                name: system.name,
                category: system.category,
                vendor: system.vendor,
                status: system.status,
                dependsOn: [],
                dependents: []
            };
        });
        
        // Add dependency relationships
        links.forEach(function(link) {
            var sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            var targetId = typeof link.target === 'object' ? link.target.id : link.target;
            
            // Only consider "depends_on" relationships
            if (link.type === 'depends_on') {
                // Target depends on source
                // Target <- Source (target system depends on source system)
                if (graph[targetId]) {
                    graph[targetId].dependsOn.push(sourceId);
                }
                
                // Source is a dependency for target
                if (graph[sourceId]) {
                    graph[sourceId].dependents.push(targetId);
                }
            }
        });
        
        return graph;
    }
    
    function determineAffectedSystems(graph, sourceId) {
        // Track affected systems with their impact level (depth)
        var affected = {};
        
        // Start with the source system
        affected[sourceId] = {
            id: sourceId,
            name: graph[sourceId].name,
            category: graph[sourceId].category,
            vendor: graph[sourceId].vendor,
            depth: 0, // Source system is at depth 0
            path: [sourceId] // Path to this system from the source
        };
        
        // Use breadth-first search to find all affected systems
        function findDependents(systemId, currentDepth, currentPath) {
            // Get direct dependents (systems that depend on this one)
            var dependents = graph[systemId] ? (graph[systemId].dependents || []) : [];
            
            dependents.forEach(function(dependentId) {
                // If this system is already affected with a shorter path, skip it
                if (affected[dependentId] && affected[dependentId].depth <= currentDepth + 1) {
                    return;
                }
                
                // Add to affected systems
                affected[dependentId] = {
                    id: dependentId,
                    name: graph[dependentId].name,
                    category: graph[dependentId].category,
                    vendor: graph[dependentId].vendor,
                    depth: currentDepth + 1,
                    path: currentPath.concat([dependentId])
                };
                
                // Recursively find systems that depend on this dependent
                findDependents(dependentId, currentDepth + 1, currentPath.concat([dependentId]));
            });
        }
        
        // Start the recursive search
        findDependents(sourceId, 0, [sourceId]);
        
        // Convert to array and sort by depth and then by name
        return Object.values(affected)
            .filter(function(system) {
                return system.id !== sourceId; // Remove source system
            })
            .sort(function(a, b) {
                if (a.depth !== b.depth) return a.depth - b.depth;
                return a.name.localeCompare(b.name);
            });
    }
    
    function buildGraphData(systems, links, affectedSystems, sourceId) {
        // Create a set of affected system IDs for easy lookup
        var affectedSystemIds = new Set([sourceId]);
        affectedSystems.forEach(function(system) {
            affectedSystemIds.add(system.id);
        });
        
        // Create nodes with augmented information
        var nodes = systems
            .filter(function(system) {
                // Include the source system and all affected systems
                return system.id === sourceId || affectedSystemIds.has(system.id);
            })
            .map(function(system) {
                // Find impact level if this is an affected system
                var impactLevel = 0;
                var impactColor = "#cbd5e1"; // Default: unaffected
                
                if (system.id === sourceId) {
                    // Source system
                    impactLevel = 0;
                    impactColor = "#ef4444"; // Red
                } else {
                    var affectedSystem = affectedSystems.find(function(s) {
                        return s.id === system.id;
                    });
                    
                    if (affectedSystem) {
                        impactLevel = affectedSystem.depth;
                        // Gradient colors for impact levels
                        if (impactLevel === 1) {
                            impactColor = "#f87171"; // Light red
                        } else if (impactLevel === 2) {
                            impactColor = "#fb923c"; // Light orange
                        } else {
                            impactColor = "#fdba74"; // Light yellow
                        }
                    }
                }
                
                return {
                    id: system.id,
                    name: system.name,
                    category: system.category,
                    vendor: system.vendor || "N/A",
                    status: system.status,
                    isSource: system.id === sourceId,
                    isAffected: affectedSystemIds.has(system.id),
                    impactLevel: impactLevel,
                    impactColor: impactColor
                };
            });
        
        // Create filtered links
        var processedLinks = [];
        var processedLinkPairs = new Set(); // To avoid duplicate links
        
        // First add direct links that show the impact paths
        affectedSystems.forEach(function(system) {
            // For each affected system, add links along its path
            var path = system.path;
            for (var i = 0; i < path.length - 1; i++) {
                var sourceNodeId = path[i];
                var targetNodeId = path[i + 1];
                var linkKey = sourceNodeId + '-' + targetNodeId;
                
                // Skip if we've already added this link
                if (processedLinkPairs.has(linkKey)) {
                    continue;
                }
                
                processedLinkPairs.add(linkKey);
                
                // Add the link
                processedLinks.push({
                    source: sourceNodeId,
                    target: targetNodeId,
                    isAffected: true
                });
            }
        });
        
        return { 
            nodes: nodes, 
            links: processedLinks 
        };
    }
    
    function renderGraph(graphData) {
        var container = document.getElementById('impact-graph');
        var containerRect = container.getBoundingClientRect();
        var width = containerRect.width;
        var height = containerRect.height;
        
        // Clear any existing SVG
        container.innerHTML = '';
        
        // Create SVG
        var svg = d3.select('#impact-graph')
            .append('svg')
            .attr('width', width)
            .attr('height', height);
            
        // Add zoom behavior
        var zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on('zoom', function(event) {
                g.attr('transform', event.transform);
            });
            
        svg.call(zoom);
        
        // Create a group to contain all elements
        var g = svg.append('g');
        
        // Create links
        var link = g.selectAll('.edge')
            .data(graphData.links)
            .enter()
            .append('path')
            .attr('class', function(d) { 
                return d.isAffected ? 'edge affected' : 'edge';
            })
            .attr('id', function(d) {
                return 'edge-' + (d.source.id || d.source) + '-' + (d.target.id || d.target);
            });
            
        // Create arrow marker for links
        svg.append('defs').selectAll('marker')
            .data(['end'])
            .enter()
            .append('marker')
            .attr('id', function(d) { return d; })
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 25)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('class', 'edge-arrow')
            .attr('d', 'M0,-5L10,0L0,5');
            
        link.attr('marker-end', 'url(#end)');
        
        // Create node groups
        var node = g.selectAll('.node')
            .data(graphData.nodes)
            .enter()
            .append('g')
            .attr('class', function(d) {
                var classes = 'node';
                if (d.isSource) classes += ' source';
                if (d.isAffected) classes += ' affected';
                return classes;
            })
            .attr('id', function(d) { return 'node-' + d.id; })
            .on('mouseover', showTooltip)
            .on('mouseout', hideTooltip)
            .on('click', function(event, d) {
                // Toggle node selection
                var isSelected = d3.select(this).classed('selected');
                
                // Deselect all nodes
                node.classed('selected', false);
                
                // If not already selected, select this node
                if (!isSelected) {
                    d3.select(this).classed('selected', true);
                }
            })
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));
                
        // Add background rectangles for nodes
        var backgroundWidth = 180;
        var backgroundHeight = 40;
        
        node.append('rect')
            .attr('class', 'node-bg')
            .attr('width', backgroundWidth)
            .attr('height', backgroundHeight)
            .attr('x', -backgroundWidth/2)
            .attr('y', -backgroundHeight/2);
            
        // Add colored rectangles for system category/type
        var typeRectWidth = 10;
        
        node.append('rect')
            .attr('class', 'node-system')
            .attr('width', typeRectWidth)
            .attr('height', backgroundHeight)
            .attr('x', -backgroundWidth/2)
            .attr('y', -backgroundHeight/2)
            .attr('style', function(d) {
                // Get color based on impact level
                var color = d.impactColor || '#cbd5e1';
                return '--color: ' + color;
            });
            
        // Add system names as text
        node.append('text')
            .attr('x', -backgroundWidth/2 + typeRectWidth + 10)
            .attr('y', 0)
            .attr('dy', '.3em')
            .text(function(d) { return d.name; })
            .each(function(d) {
                // Truncate text if too long
                var textElement = d3.select(this);
                var maxWidth = backgroundWidth - typeRectWidth - 20;
                var text = d.name;
                
                while (this.getComputedTextLength() > maxWidth && text.length > 3) {
                    text = text.slice(0, -1);
                    textElement.text(text + '...');
                }
            });
            
        // Create simulation
        var simulation = d3.forceSimulation(graphData.nodes)
            .force('link', d3.forceLink(graphData.links).id(function(d) { return d.id; }).distance(200))
            .force('charge', d3.forceManyBody().strength(-500))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(100))
            .on('tick', ticked);
            
        // Simulation tick function
        function ticked() {
            link.attr('d', function(d) {
                var sourceX = d.source.x;
                var sourceY = d.source.y;
                var targetX = d.target.x;
                var targetY = d.target.y;
                
                // Calculate the total distance
                var dx = targetX - sourceX;
                var dy = targetY - sourceY;
                var dist = Math.sqrt(dx * dx + dy * dy);
                
                // If distance is too small, return a small line
                if (dist < 1) {
                    return 'M' + sourceX + ',' + sourceY + 'L' + (sourceX + 1) + ',' + (sourceY + 1);
                }
                
                // Calculate offsets to account for node size
                var offsetX = (dx * backgroundWidth/2) / dist;
                var offsetY = (dy * backgroundHeight/2) / dist;
                
                // Start and end points with offsets
                var startX = sourceX + offsetX;
                var startY = sourceY + offsetY;
                var endX = targetX - offsetX;
                var endY = targetY - offsetY;
                
                return 'M' + startX + ',' + startY + 'L' + endX + ',' + endY;
            });
            
            node.attr('transform', function(d) {
                return 'translate(' + d.x + ',' + d.y + ')';
            });
        }
        
        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            // Keep positions fixed for better UX
            // Uncomment below to release positions after drag
            // d.fx = null;
            // d.fy = null;
        }
        
        // Add tooltip functions
        function showTooltip(event, d) {
            // Create tooltip if it doesn't exist
            var tooltip = d3.select('.tooltip');
            if (tooltip.empty()) {
                tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('opacity', 0);
            }
            
            // Set tooltip content
            var html = '<div><strong>' + d.name + '</strong></div>';
            if (d.category) {
                html += '<div>Category: <span style="color: ' + d.category.text_color + ';">' + d.category.name + '</span></div>';
            }
            if (d.vendor && d.vendor !== 'N/A') {
                html += '<div>Vendor: ' + d.vendor + '</div>';
            }
            if (d.impactLevel > 0) {
                html += '<div>Impact Level: ' + d.impactLevel + '</div>';
            }
            
            tooltip.html(html)
                .style('left', (event.pageX) + 'px')
                .style('top', (event.pageY - 28) + 'px')
                .transition()
                .duration(200)
                .style('opacity', 0.9);
        }

        function hideTooltip() {
            d3.select('.tooltip').transition()
                .duration(500)
                .style('opacity', 0);
        }
        
        // Set up zoom controls
        document.getElementById('zoom-in').addEventListener('click', function() {
            svg.transition().duration(300).call(zoom.scaleBy, 1.2);
        });
        
        document.getElementById('zoom-out').addEventListener('click', function() {
            svg.transition().duration(300).call(zoom.scaleBy, 0.8);
        });
        
        document.getElementById('reset-zoom').addEventListener('click', function() {
            svg.transition().duration(300).call(zoom.transform, d3.zoomIdentity);
        });
        
        // Depth control for visualization
        document.getElementById('depth-control').addEventListener('change', function() {
            var depthLimit = parseInt(this.value);
            filterByDepth(depthLimit);
        });
        
        // Filter nodes by impact depth
        function filterByDepth(depth) {
            // If depth is 0 (all levels), show all nodes
            if (depth === 0) {
                node.style('display', 'block');
                link.style('display', 'block');
                return;
            }
            
            // Hide all nodes and links first
            node.style('display', 'none');
            link.style('display', 'none');
            
            // Always show source node
            d3.select('#node-' + sourceSystemId).style('display', 'block');
            
            // Filter affected systems by depth
            var filteredAffectedSystems = affectedSystemsData.filter(function(system) {
                return system.depth <= depth;
            });
            
            // Show filtered affected systems
            filteredAffectedSystems.forEach(function(system) {
                // Show this system node
                d3.select('#node-' + system.id).style('display', 'block');
                
                // Show path links to this system
                var path = system.path;
                for (var i = 0; i < path.length - 1; i++) {
                    var sourceNodeId = path[i];
                    var targetNodeId = path[i + 1];
                    d3.select('#edge-' + sourceNodeId + '-' + targetNodeId).style('display', 'block');
                }
            });
        }
        
        // Initial layout - center on source node and fit diagram
        function centerDiagram() {
            // Find the source node
            var sourceNode = graphData.nodes.find(function(n) {
                return n.id === sourceSystemId;
            });
            
            if (sourceNode && sourceNode.x && sourceNode.y) {
                // Calculate transform to center on source node
                var tx = width / 2 - sourceNode.x;
                var ty = height / 2 - sourceNode.y;
                
                // Apply transform with slight delay to allow simulation to start
                setTimeout(function() {
                    svg.transition()
                        .duration(750)
                        .call(zoom.transform, d3.zoomIdentity.translate(tx, ty));
                }, 500);
            }
        }
        
        // Run the simulation for a bit to get a good layout
        simulation.alpha(1).restart();
        
        // Center diagram after a short delay
        setTimeout(centerDiagram, 100);
    }
    
    function populateImpactSummary(affectedSystems) {
        // Calculate statistics
        var totalAffected = affectedSystems.length;
        var directlyAffected = affectedSystems.filter(function(s) {
            return s.depth === 1;
        }).length;
        var indirectlyAffected = totalAffected - directlyAffected;
        var maxDepth = affectedSystems.length > 0 ? 
            Math.max.apply(null, affectedSystems.map(function(s) { return s.depth; })) : 0;
        
        // Update statistics in the UI
        document.getElementById('total-affected').textContent = totalAffected;
        document.getElementById('direct-affected').textContent = directlyAffected;
        document.getElementById('indirect-affected').textContent = indirectlyAffected;
        document.getElementById('max-depth').textContent = maxDepth;
        
        // Populate affected systems table
        var tableBody = document.getElementById('affected-systems-body');
        
        if (affectedSystems.length === 0) {
            tableBody.innerHTML = 
                '<tr>' +
                '<td colspan="4" class="text-center py-4 text-gray-500">' +
                'No affected systems found. This system is not a dependency for any other system.' +
                '</td>' +
                '</tr>';
            return;
        }
        
        var tableHtml = '';
        
        affectedSystems.forEach(function(system) {
            var impactLevel = system.depth === 1 ? "Direct" : "Indirect (L" + system.depth + ")";
            var impactClass = system.depth === 1 ? "bg-red-100 text-red-800" : "bg-orange-100 text-orange-800";
            
            tableHtml += 
                '<tr>' +
                '<td>' +
                '<a href="' + systemDetailUrl.replace('0', system.id) + '" class="text-blue-600 hover:underline">' +
                system.name +
                '</a>' +
                '</td>' +
                '<td>' +
                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" ' + 
                'style="background-color: ' + system.category.color + '; color: ' + system.category.text_color + '">' +
                system.category.name +
                '</span>' +
                '</td>' +
                '<td>' + (system.vendor || "N/A") + '</td>' +
                '<td>' +
                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + impactClass + '">' +
                impactLevel +
                '</span>' +
                '</td>' +
                '</tr>';
        });
        
        tableBody.innerHTML = tableHtml;
    }
    
    // Export report handler
    document.getElementById('export-report').addEventListener('click', function(e) {
        e.preventDefault();
        alert("Export functionality temporarily disabled.");
    });
});
</script>
{% endblock %}