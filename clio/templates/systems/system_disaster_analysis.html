{% extends "base.html" %}
{% load static %}

{% block title %}Disaster Impact Analysis - {{ system.name }} - Clio{% endblock %}

{% block page_header %}
<div class="md:flex md:items-center md:justify-between">
    <div class="flex-1 min-w-0">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
            Disaster Impact Analysis: {{ system.name }}
        </h2>
        <div class="mt-1 flex flex-col sm:flex-row sm:flex-wrap sm:mt-0 sm:space-x-6">
            <div class="mt-2 flex items-center text-sm text-gray-500">
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                      style="background-color: {{ system.category.color }}; color: {{ system.category.text_color }}">
                    {{ system.category.name }}
                </span>
            </div>
            <div class="mt-2 flex items-center text-sm text-gray-500">
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                      style="background-color: {{ system.status.color }}; color: {{ system.status.text_color }}">
                    {{ system.status.name }}
                </span>
            </div>
        </div>
    </div>
    <div class="mt-4 flex md:mt-0 md:ml-4">
        <button id="runDisasterSimulation" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-amber-500 hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500" style="background-color: #F1C052; border-color: #E5B142;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Run Simulation
        </button>
        <a href="{% url 'systems:detail' system.id %}" class="ml-3 inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Back to System
        </a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Base styling for impact badges */
    .impact-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
    }
    
    .impact-badge-primary {
        background-color: #fee2e2;
        color: #b91c1c;
    }
    
    .impact-badge-secondary {
        background-color: #ffedd5;
        color: #c2410c;
    }
    
    .impact-badge-tertiary {
        background-color: #fef9c3;
        color: #854d0e;
    }
    
    .impact-badge-quaternary {
        background-color: #e0f2fe;
        color: #0369a1;
    }
    
    /* Legend styling */
    .legend {
        display: flex;
        flex-direction: column;
        padding: 8px;
        background-color: white;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .legend-title {
        font-weight: 600;
        margin-bottom: 8px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        margin-right: 8px;
        border-radius: 3px;
    }
    
    /* Better empty state */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem;
        text-align: center;
    }
    
    .empty-state svg {
        color: #9ca3af;
        margin-bottom: 1rem;
    }
    
    /* Controls panel */
    .controls-panel {
        margin-bottom: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .control-button {
        padding: 0.5rem 1rem;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }
    
    .control-button:hover {
        background-color: #f9fafb;
    }
    
    .control-button.active {
        background-color: #ef4444;
        border-color: #dc2626;
        color: white;
    }
    
    /* Recovery step styling */
    .recovery-step {
        position: relative;
        border-left: 4px solid #3b82f6;
        padding-left: 1.5rem;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .recovery-step-number {
        position: absolute;
        left: -1.25rem;
        top: -0.25rem;
        height: 2.5rem;
        width: 2.5rem;
        background-color: #3b82f6;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    /* Path visualization */
    .impact-path {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    
    .impact-path-header {
        padding: 0.75rem 1rem;
        font-weight: 600;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .path-header-primary {
        background-color: #fee2e2;
        color: #b91c1c;
    }
    
    .path-header-secondary {
        background-color: #ffedd5;
        color: #c2410c;
    }
    
    .path-header-tertiary {
        background-color: #fef9c3;
        color: #854d0e;
    }
    
    .path-header-quaternary {
        background-color: #e0f2fe;
        color: #0369a1;
    }
    
    .impact-path-body {
        padding: 1rem;
        background-color: white;
    }
    
    .dependency-chain {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .chain-node {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        margin-right: 0.5rem;
        white-space: nowrap;
        font-weight: 500;
    }
    
    .chain-arrow {
        margin: 0 0.25rem;
        color: #9ca3af;
    }
    
    .connection-type-badge {
        font-size: 0.625rem;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        margin-left: 0.25rem;
        vertical-align: top;
    }
    
    .connection-direct-badge {
        background-color: #e5e7eb;
        color: #4b5563;
    }
    
    .connection-sso-badge {
        background-color: #dbeafe;
        color: #1d4ed8;
    }
    
    .connection-hosting-badge {
        background-color: #f3e8ff;
        color: #7e22ce;
    }
    
    /* Dependency path filter */
    .path-filter-control {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background-color: #f3f4f6;
        border-radius: 0.5rem;
    }
    
    /* Collapsible sections */
    .collapse-trigger {
        cursor: pointer;
    }
    
    .collapse-trigger svg {
        transition: transform 0.2s;
    }
    
    .collapse-trigger.collapsed svg {
        transform: rotate(-90deg);
    }
    
    .collapsible-content {
        transition: max-height 0.3s ease-out;
        max-height: 2000px;
        overflow: hidden;
    }
    
    .collapsible-content.collapsed {
        max-height: 0;
    }
    
    /* System card styling */
    .system-card {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
    }
    
    .system-card:hover {
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-color: #d1d5db;
    }
    
    .system-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }
    
    .system-card-body {
        font-size: 0.875rem;
        color: #4b5563;
    }
    
    .system-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #f3f4f6;
        font-size: 0.75rem;
    }
    
    /* Recovery Plan Integration */
    .system-recovery-plan {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background-color: #f3f4f6;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }
    
    .recovery-step-link {
        display: inline-flex;
        align-items: center;
        color: #2563eb;
        font-weight: 500;
    }
    
    .recovery-step-link svg {
        width: 0.875rem;
        height: 0.875rem;
        margin-right: 0.25rem;
    }
    
    /* Filter and sort controls */
    .filter-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background-color: #f9fafb;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-group label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #4b5563;
        margin-bottom: 0.25rem;
    }
    
    .filter-group select,
    .filter-group input {
        border-radius: 0.25rem;
        border: 1px solid #d1d5db;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    @media (max-width: 640px) {
        .filter-bar {
            flex-direction: column;
        }
        
        .dependency-chain {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .chain-node {
            margin-bottom: 0.5rem;
        }
        
        .chain-arrow {
            transform: rotate(90deg);
            margin: 0.25rem 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 bg-amber-50">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-amber-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-md leading-6 font-medium text-gray-900">
                    Failure Impact Assessment
                </h3>
                <p class="mt-1 text-sm text-gray-500">
                    This analysis shows the cascading impact of a failure in {{ system.name }}. The analysis displays dependency relationships and how failures would propagate through connected systems.
                </p>
            </div>
        </div>
    </div>
    
    <div class="border-t border-gray-200">
        <div id="disaster-simulation-results" class="px-4 py-5 sm:p-6 hidden">
            <div class="mb-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-base font-medium text-gray-900">Impact Summary</h3>
                    <span id="total-affected-count" class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"></span>
                </div>
                <div class="mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="impact-progress" class="bg-red-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Impact Legend -->
            <div class="legend mb-4">
                <div class="legend-title">Impact Legend</div>
                <div class="flex flex-wrap gap-3">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #fee2e2; border: 1px solid #ef4444;"></div>
                        <span>Primary Impact</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffedd5; border: 1px solid #f97316;"></div>
                        <span>Secondary Impact</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #fef9c3; border: 1px solid #eab308;"></div>
                        <span>Tertiary Impact</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #dbeafe; border: 1px solid #60a5fa;"></div>
                        <span>Distant Impact (4+)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e0f2fe; border: 1px solid #0ea5e9;"></div>
                        <span>SSO Dependency</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f3e8ff; border: 1px solid #a855f7;"></div>
                        <span>Hosting Dependency</span>
                    </div>
                </div>
            </div>
            
            <!-- Impact Metrics -->
            <div class="mt-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3">
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Systems Affected
                            </dt>
                            <dd id="systems-affected" class="mt-1 text-3xl font-semibold text-gray-900">
                                --
                            </dd>
                        </dl>
                    </div>
                </div>
                
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Estimated Recovery Time
                            </dt>
                            <dd id="recovery-time" class="mt-1 text-3xl font-semibold text-gray-900">
                                --
                            </dd>
                        </dl>
                    </div>
                </div>
                
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                User Impact Estimate
                            </dt>
                            <dd id="user-impact" class="mt-1 text-3xl font-semibold text-gray-900">
                                --
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
            
            <!-- Impact Lists -->
            <div class="mt-8">
                <div class="flex items-center justify-between mb-4 collapse-trigger" id="impactBreakdownHeader">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                        Impact Breakdown
                    </h3>
                </div>
                
                <div class="collapsible-content" id="impactBreakdownContent">
                    <!-- Filter Bar -->
                    <div class="filter-bar mb-4">
                        <div class="filter-group">
                            <label for="categoryFilter">Filter by Category</label>
                            <select id="categoryFilter" class="text-sm">
                                <option value="all">All Categories</option>
                                {% for category in all_categories %}
                                <option value="{{ category.slug }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="vendorFilter">Filter by Vendor</label>
                            <select id="vendorFilter" class="text-sm">
                                <option value="all">All Vendors</option>
                                {% for vendor in all_vendors %}
                                <option value="{{ vendor }}">{{ vendor }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="systemSort">Sort by</label>
                            <select id="systemSort" class="text-sm">
                                <option value="impact">Impact Score (High to Low)</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="recovery">Recovery Time (Longest First)</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="connectionTypeFilter">Connection Types</label>
                            <div class="flex gap-3 mt-1">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="h-4 w-4" id="showDirectConnections" checked>
                                    <span class="ml-1 text-sm">Direct</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="h-4 w-4" id="showSSOConnections" checked>
                                    <span class="ml-1 text-sm">SSO</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="h-4 w-4" id="showHostingConnections" checked>
                                    <span class="ml-1 text-sm">Hosting</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                        <!-- Primary Impact (Tier 1) -->
                        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6 bg-red-50">
                                <h4 class="text-base font-medium text-red-700 flex items-center">
                                    <span class="inline-block w-3 h-3 bg-red-700 rounded-full mr-2"></span>
                                    Primary Impact Systems
                                </h4>
                                <p class="mt-1 text-xs text-red-600">
                                    Systems directly dependent on {{ system.name }}
                                </p>
                            </div>
                            <div class="border-t border-gray-200">
                                <div id="primary-impact-systems" class="divide-y divide-gray-200">
                                    <!-- Will be populated by JavaScript -->
                                    <div class="p-4 text-sm text-gray-500 text-center">No systems found</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Secondary Impact (Tier 2) -->
                        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6 bg-orange-50">
                                <h4 class="text-base font-medium text-orange-700 flex items-center">
                                    <span class="inline-block w-3 h-3 bg-orange-600 rounded-full mr-2"></span>
                                    Secondary Impact Systems
                                </h4>
                                <p class="mt-1 text-xs text-orange-600">
                                    Systems dependent on primary impact systems
                                </p>
                            </div>
                            <div class="border-t border-gray-200">
                                <div id="secondary-impact-systems" class="divide-y divide-gray-200">
                                    <!-- Will be populated by JavaScript -->
                                    <div class="p-4 text-sm text-gray-500 text-center">No systems found</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tertiary Impact (Tier 3) -->
                        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6 bg-yellow-50">
                                <h4 class="text-base font-medium text-yellow-700 flex items-center">
                                    <span class="inline-block w-3 h-3 bg-yellow-600 rounded-full mr-2"></span>
                                    Tertiary Impact Systems
                                </h4>
                                <p class="mt-1 text-xs text-yellow-600">
                                    Systems dependent on secondary impact systems
                                </p>
                            </div>
                            <div class="border-t border-gray-200">
                                <div id="tertiary-impact-systems" class="divide-y divide-gray-200">
                                    <!-- Will be populated by JavaScript -->
                                    <div class="p-4 text-sm text-gray-500 text-center">No systems found</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quaternary Impact (Tier 4+) -->
                        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6 bg-blue-50">
                                <h4 class="text-base font-medium text-blue-700 flex items-center">
                                    <span class="inline-block w-3 h-3 bg-blue-600 rounded-full mr-2"></span>
                                    Distant Impact Systems
                                </h4>
                                <p class="mt-1 text-xs text-blue-600">
                                    Systems with 4+ degrees of separation
                                </p>
                            </div>
                            <div class="border-t border-gray-200">
                                <div id="quaternary-impact-systems" class="divide-y divide-gray-200">
                                    <!-- Will be populated by JavaScript -->
                                    <div class="p-4 text-sm text-gray-500 text-center">No systems found</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Complete Downstream Impact Paths -->
            <div class="mt-8">
                <div class="flex items-center justify-between mb-4 collapse-trigger" id="impactPathsHeader">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                        Complete Dependency Chains
                    </h3>
                    <span class="text-sm text-gray-500" id="totalPathsCount">0 paths identified</span>
                </div>
                
                <div class="collapsible-content" id="impactPathsContent">
                    <!-- Path filter options -->
                    <div class="path-filter-control">
                        <div class="flex flex-wrap gap-4 items-center">
                            <div>
                                <label for="pathTypeFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by impact level:</label>
                                <select id="pathTypeFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                    <option value="all">All Impact Levels</option>
                                    <option value="primary">Primary Impact</option>
                                    <option value="secondary">Secondary Impact</option>
                                    <option value="tertiary">Tertiary Impact</option>
                                    <option value="quaternary">Distant Impact (4+)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="pathSortOrder" class="block text-sm font-medium text-gray-700 mb-1">Sort by:</label>
                                <select id="pathSortOrder" class="mt-1 block w-full pl-3 pr-10 py-2 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                    <option value="impact">Impact Score (Highest First)</option>
                                    <option value="path-length">Path Length (Shortest First)</option>
                                    <option value="alphabetical">System Name (A-Z)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="connectionTypeFilter" class="block text-sm font-medium text-gray-700 mb-1">Connection types:</label>
                                <div class="flex items-center gap-3 mt-2">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" id="showDirectConnectionsPath" checked>
                                        <span class="ml-2 text-sm text-gray-700">Direct</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" id="showSSOConnectionsPath" checked>
                                        <span class="ml-2 text-sm text-gray-700">SSO</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" id="showHostingConnectionsPath" checked>
                                        <span class="ml-2 text-sm text-gray-700">Hosting</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Impact paths container -->
                    <div id="impact-paths-container" class="mt-4 space-y-4">
                        <!-- Will be populated by JavaScript -->
                        <div class="empty-state py-8">
                            <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Run the simulation to see complete impact paths</h3>
                            <p class="mt-1 text-sm text-gray-500">
                                Failure dependency chains will be displayed here after running the impact analysis.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="disaster-simulation-placeholder" class="px-4 py-12 sm:p-6 text-center">
            <div class="empty-state">
                <svg class="h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No simulation results</h3>
                <p class="mt-1 text-sm text-gray-500">
                    Click "Run Simulation" to analyze the potential impact of a failure in this system.
                </p>
                <div class="mt-6">
                    <button type="button" id="runSimulationFromPlaceholder" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500" style="background-color: #F1C052; border-color: #E5B142;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Run Simulation
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Disaster Recovery Plan -->
<div class="mt-6 bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
        <div>
            <h4 class="text-md leading-6 font-medium text-gray-900">
                Disaster Recovery Plan
            </h4>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">
                Step-by-step recovery process in case of system failure.
            </p>
        </div>
        <button id="addRecoveryStepBtn" class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
            Add Step
        </button>
    </div>
    <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
        <div id="recovery-steps-container" class="space-y-6">
            {% if recovery_steps %}
                {% for step in recovery_steps %}
                <div class="recovery-step relative border-l-4 border-blue-600 pl-4 py-2" data-step-id="{{ step.id }}">
                    <div class="absolute -left-5 -top-1 h-10 w-10 rounded-full bg-blue-600 flex items-center justify-center">
                        <span class="text-xs font-medium text-white">{{ step.order }}</span>
                    </div>
                    <div class="flex justify-between items-start ml-4">
                        <div>
                            <h5 class="text-sm font-medium text-gray-900">{{ step.title }}</h5>
                            <p class="mt-1 text-sm text-gray-500">{{ step.description|linebreaksbr }}</p>
                            
                            {% if step.responsible_team or step.estimated_time %}
                            <div class="mt-2 flex space-x-4 text-xs text-gray-500">
                                {% if step.responsible_team %}
                                <div>
                                    <span class="font-medium">Team:</span> {{ step.responsible_team }}
                                </div>
                                {% endif %}
                                
                                {% if step.estimated_time %}
                                <div>
                                    <span class="font-medium">Est. Time:</span> {{ step.estimated_time }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" class="text-blue-600 hover:text-blue-900 edit-step" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button type="button" class="text-red-600 hover:text-red-900 delete-step" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                            {% if not forloop.first %}
                            <button type="button" class="text-gray-600 hover:text-gray-900 move-step-up" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </button>
                            {% endif %}
                            {% if not forloop.last %}
                            <button type="button" class="text-gray-600 hover:text-gray-900 move-step-down" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div id="empty-recovery-steps" class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No recovery steps</h3>
                    <p class="mt-1 text-sm text-gray-500">
                        Start by adding the first step to your disaster recovery plan.
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recovery Step Modal -->
<div id="recoveryStepModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4" id="stepModalTitle">Add Recovery Step</h3>
        <form id="recoveryStepForm" method="post" action="{% url 'systems:save_recovery_step' system.id %}">
            {% csrf_token %}
            <input type="hidden" name="step_id" id="stepId" value="">
            
            <div class="mb-4">
                <label for="stepTitle" class="block text-sm font-medium text-gray-700">Title</label>
                <input type="text" id="stepTitle" name="title" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
            </div>
            
            <div class="mb-4">
                <label for="stepDescription" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="stepDescription" name="description" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required></textarea>
            </div>
            
            <div class="mb-4">
                <label for="responsibleTeam" class="block text-sm font-medium text-gray-700">Responsible Team</label>
                <input type="text" id="responsibleTeam" name="responsible_team" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            
            <div class="mb-4">
                <label for="estimatedTime" class="block text-sm font-medium text-gray-700">Estimated Time</label>
                <input type="text" id="estimatedTime" name="estimated_time" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g. 30 minutes, 2 hours">
            </div>
            
            <div class="mt-5 sm:mt-6 flex justify-end space-x-3">
                <button type="button" id="cancelStepModal" class="inline-flex justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </button>
                <button type="submit" class="inline-flex justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Step Confirmation Modal -->
<div id="deleteStepModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Remove Recovery Step</h3>
        <p class="text-sm text-gray-500 mb-4">
            Are you sure you want to remove this recovery step from the plan? This action cannot be undone.
        </p>
        <form id="deleteStepForm" method="post" action="{% url 'systems:delete_recovery_step' system.id 0 %}">
            {% csrf_token %}
            <input type="hidden" name="step_id" id="deleteStepId" value="">
            
            <div class="mt-5 sm:mt-6 flex justify-end space-x-3">
                <button type="button" id="cancelDeleteStep" class="inline-flex justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </button>
                <button type="submit" class="inline-flex justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Remove
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize global variables for system data
const currentSystemId = {{ system.id }};
const currentSystemName = "{{ system.name }}";
const currentSystemCategory = "{{ system.category.slug }}";
const currentSystemCategoryName = "{{ system.category.name }}";
const currentSystemCategoryColor = "{{ system.category.color }}";
const currentSystemCategoryTextColor = "{{ system.category.text_color }}";
const currentSystemStatusSlug = "{{ system.status.slug }}";
const currentSystemStatusName = "{{ system.status.name }}";
const currentSystemStatusColor = "{{ system.status.color }}";
const currentSystemStatusTextColor = "{{ system.status.text_color }}";
const currentSystemVendor = "{{ system.vendor|default:'Unknown' }}";
const currentSystemSsoId = {% if system.sso_system %}{{ system.sso_system.id }}{% else %}null{% endif %};
const currentSystemHostingId = {% if system.hosting_system %}{{ system.hosting_system.id }}{% else %}null{% endif %};

// Initialize arrays for related systems
const dependencies = [
    {% for dep in dependencies %}
    {
        id: {{ dep.id }},
        name: "{{ dep.name }}",
        category: {
            slug: "{{ dep.category.slug }}",
            name: "{{ dep.category.name }}",
            color: "{{ dep.category.color }}",
            text_color: "{{ dep.category.text_color }}"
        },
        status: {
            slug: "{{ dep.status.slug }}",
            name: "{{ dep.status.name }}",
            color: "{{ dep.status.color }}",
            text_color: "{{ dep.status.text_color }}"
        },
        vendor: "{{ dep.vendor|default:'Unknown' }}"
    },
    {% endfor %}
];

const dependents = [
    {% for dep in dependents %}
    {
        id: {{ dep.id }},
        name: "{{ dep.name }}",
        category: {
            slug: "{{ dep.category.slug }}",
            name: "{{ dep.category.name }}",
            color: "{{ dep.category.color }}",
            text_color: "{{ dep.category.text_color }}"
        },
        status: {
            slug: "{{ dep.status.slug }}",
            name: "{{ dep.status.name }}",
            color: "{{ dep.status.color }}",
            text_color: "{{ dep.status.text_color }}"
        },
        vendor: "{{ dep.vendor|default:'Unknown' }}"
    },
    {% endfor %}
];

const ssoDependents = [
    {% for dep in sso_dependents %}
    {
        id: {{ dep.id }},
        name: "{{ dep.name }}",
        category: {
            slug: "{{ dep.category.slug }}",
            name: "{{ dep.category.name }}",
            color: "{{ dep.category.color }}",
            text_color: "{{ dep.category.text_color }}"
        },
        status: {
            slug: "{{ dep.status.slug }}",
            name: "{{ dep.status.name }}",
            color: "{{ dep.status.color }}",
            text_color: "{{ dep.status.text_color }}"
        },
        vendor: "{{ dep.vendor|default:'Unknown' }}"
    },
    {% endfor %}
];

const hostedSystems = [
    {% for sys in hosted_systems %}
    {
        id: {{ sys.id }},
        name: "{{ sys.name }}",
        category: {
            slug: "{{ sys.category.slug }}",
            name: "{{ sys.category.name }}",
            color: "{{ sys.category.color }}",
            text_color: "{{ sys.category.text_color }}"
        },
        status: {
            slug: "{{ sys.status.slug }}",
            name: "{{ sys.status.name }}",
            color: "{{ sys.status.color }}",
            text_color: "{{ sys.status.text_color }}"
        },
        vendor: "{{ sys.vendor|default:'Unknown' }}"
    },
    {% endfor %}
];

// Global variables for simulation data
let dependencyGraph = null;
let allSystems = null;
let allRelationships = null;
let impactData = null;
let completeImpactPaths = [];

// Function to fetch all systems and relationships from API
async function fetchAllSystemsAndRelationships() {
    try {
        console.log("Fetching all systems and relationships from API...");
        const response = await fetch('/systems/api/relationships/');
        if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.status}`);
        }
        const data = await response.json();
        console.log("Fetched data:", data);
        return data;
    } catch (error) {
        console.error("Error fetching systems and relationships:", error);
        return { systems: [], links: [] };
    }
}

// CORE FUNCTIONS FOR DEPENDENCY ANALYSIS

// Build a complete dependency graph from all system relationships
async function buildCompleteGraph() {
    console.log("Building complete dependency graph...");
    
    // Fetch all systems and relationships from API if not already loaded
    if (!allSystems || !allRelationships) {
        const data = await fetchAllSystemsAndRelationships();
        allSystems = data.systems || [];
        allRelationships = data.links || [];
    }
    
    // Create a graph structure to hold all systems and their relationships
    const graph = {
        nodes: {},         // All system nodes
        dependencies: {},  // What THIS system depends on
        dependents: {},    // What depends on THIS system
        ssoRelations: {},  // Track SSO relationships
        hostingRelations: {} // Track hosting relationships
    };
    
    // First, add all systems we know about to the graph
    const systemsToAdd = [];
    
    // Add the current system
    const currentSystem = {
        id: currentSystemId,
        name: currentSystemName,
        category: {
            slug: currentSystemCategory,
            name: currentSystemCategoryName,
            color: currentSystemCategoryColor,
            text_color: currentSystemCategoryTextColor
        },
        status: {
            slug: currentSystemStatusSlug,
            name: currentSystemStatusName,
            color: currentSystemStatusColor,
            text_color: currentSystemStatusTextColor
        },
        vendor: currentSystemVendor || 'Unknown'
    };
    
    systemsToAdd.push(currentSystem);
    
    // Add direct dependencies and dependents we already know about
    dependencies.forEach(dep => systemsToAdd.push(dep));
    dependents.forEach(dep => systemsToAdd.push(dep));
    ssoDependents.forEach(dep => systemsToAdd.push(dep));
    hostedSystems.forEach(sys => systemsToAdd.push(sys));
    
    // Add all systems from the API
    allSystems.forEach(system => {
        systemsToAdd.push(system);
    });
    
    // Initialize graph with all systems
    systemsToAdd.forEach(system => {
        // Skip duplicates
        if (graph.nodes[system.id]) return;
        
        graph.nodes[system.id] = system;
        graph.dependencies[system.id] = [];
        graph.dependents[system.id] = [];
    });
    
    // Add relationships to the graph
    function addDependencyRelationship(sourceId, targetId, type) {
        // Skip if either node doesn't exist
        if (!graph.nodes[sourceId] || !graph.nodes[targetId]) {
            console.log(`Skipping relationship ${sourceId} -> ${targetId} (node missing)`);
            return;
        }
        
        // CRITICAL: When sourceId depends on targetId, it means:
        // - sourceId needs targetId to function
        // - If targetId fails, sourceId is impacted
        console.log(`Adding relationship: ${sourceId} depends on ${targetId} (type: ${type})`);
        
        // Add dependency: source depends on target
        if (!graph.dependencies[sourceId].includes(targetId)) {
            graph.dependencies[sourceId].push(targetId);
        }
        
        // Add dependent: target is depended on by source
        if (!graph.dependents[targetId].includes(sourceId)) {
            graph.dependents[targetId].push(sourceId);
        }
        
        // Track special relationship types
        if (type === 'sso') {
            graph.ssoRelations[sourceId] = targetId;
        } else if (type === 'hosting') {
            graph.hostingRelations[sourceId] = targetId;
        }
    }
    
    // Add direct dependencies from server-side data
    dependencies.forEach(dep => {
        // When currentSystemId depends on dep.id
        addDependencyRelationship(currentSystemId, dep.id, 'direct');
    });
    
    // Add direct dependents from server-side data
    dependents.forEach(dep => {
        // When dep.id depends on currentSystemId
        addDependencyRelationship(dep.id, currentSystemId, 'direct');
    });
    
    // Add SSO relationships
    if (currentSystemSsoId) {
        addDependencyRelationship(currentSystemId, currentSystemSsoId, 'sso');
    }
    
    ssoDependents.forEach(dep => {
        addDependencyRelationship(dep.id, currentSystemId, 'sso');
    });
    
    // Add hosting relationships
    if (currentSystemHostingId) {
        addDependencyRelationship(currentSystemId, currentSystemHostingId, 'hosting');
    }
    
    hostedSystems.forEach(sys => {
        addDependencyRelationship(sys.id, currentSystemId, 'hosting');
    });
    
    // Add all relationships from the API
    allRelationships.forEach(rel => {
        if (rel.type === 'depends_on') {
            // CRITICAL: If source depends_on target, then when target fails, source is impacted
            addDependencyRelationship(rel.source, rel.target, 'direct');
        }
    });
    
    console.log("Complete dependency graph built:", graph);
    return graph;
}

// Helper function to get impact level name from level number
function getImpactLevelName(level) {
    switch(level) {
        case 1: return 'primary';
        case 2: return 'secondary';
        case 3: return 'tertiary';
        default: return 'quaternary'; // Level 4 and beyond
    }
}

// Helper function to explicitly check dependency direction
function buildDependencyMap(dependencyGraph) {
    // Create an explicit map showing which systems would be affected if a system fails
    // In other words, which systems DEPEND ON a given system
    const dependentsMap = {};
    
    // Initialize the map for all systems
    Object.keys(dependencyGraph.nodes).forEach(id => {
        dependentsMap[id] = [];
    });
    
    // Process all relationships to ensure correct impact direction
    console.log("Processing relationship data to determine accurate impact direction");
    
    // Debugging: Log dependency data
    console.log("Dependencies (A depends on B):", dependencyGraph.dependencies);
    
    // Process each system's dependencies to build the dependents map correctly
    // If A depends on B, then B's failure affects A (A is in B's dependents list)
    Object.entries(dependencyGraph.dependencies).forEach(([systemId, dependencies]) => {
        // For each system that thisSystem depends on
        dependencies.forEach(depId => {
            console.log(`System ${systemId} depends on system ${depId}`);
            
            // Make sure depId's dependents list includes systemId
            // (systemId will be affected if depId fails)
            if (!dependentsMap[depId]) {
                dependentsMap[depId] = [];
            }
            
            if (!dependentsMap[depId].includes(parseInt(systemId))) {
                dependentsMap[depId].push(parseInt(systemId));
            }
        });
    });
    
    // Debug: Print out the dependents map
    Object.entries(dependentsMap).forEach(([systemId, dependents]) => {
        if (dependents.length > 0) {
            const systemName = dependencyGraph.nodes[systemId] ? dependencyGraph.nodes[systemId].name : 'Unknown';
            console.log(`If system ${systemId} (${systemName}) fails, these systems are affected:`, dependents.map(id => {
                const name = dependencyGraph.nodes[id] ? dependencyGraph.nodes[id].name : 'Unknown';
                return `${id} (${name})`;
            }));
        }
    });
    
    return dependentsMap;
}

// Calculate impact score for a system based on its properties
function calculateSystemImpact(system, tierFactor) {
    // Base impact score
    let impact = 5;
    
    // Factor in system category
    switch (system.category.slug) {
        case 'core':
            impact *= 2.0; // Core systems have highest impact
            break;
        case 'integration':
            impact *= 1.5; // Integration systems have high impact
            break;
        case 'custom':
            impact *= 1.2; // Custom systems have medium impact
            break;
        case 'server':
            impact *= 1.8; // Server systems have high-impact
            break;
        case 'external':
            impact *= 1.0; // External systems have standard impact
            break;
    }
    
    // Adjust by tier factor
    impact *= tierFactor;
    
    // Round to integer
    return Math.round(impact);
}

// Estimate recovery time based on impact data
function estimateRecoveryTime(primarySystems, secondaryImpactSystems, tertiaryImpactSystems) {
    // Base recovery time in hours
    let recoveryTime = 2;
    
    // Add time based on number of affected systems
    recoveryTime += primarySystems.length * 2; // 2 hours per primary system
    recoveryTime += secondaryImpactSystems.length * 0.8; // 48 minutes per secondary impact system
    recoveryTime += tertiaryImpactSystems.length * 0.3; // 18 minutes per tertiary impact system
    
    // Add complexity factor based on system types
    const hasCore = primarySystems.some(s => s.category.slug === 'core') || 
                  secondaryImpactSystems.some(s => s.category.slug === 'core');
                  
    const hasExternal = primarySystems.some(s => s.category.slug === 'external') || 
                      secondaryImpactSystems.some(s => s.category.slug === 'external');
    
    const hasServer = primarySystems.some(s => s.category.slug === 'server');
    
    if (hasCore) recoveryTime *= 1.5; // Core systems take 50% longer to recover
    if (hasExternal) recoveryTime *= 1.3; // External systems add 30% to recovery time
    if (hasServer) recoveryTime *= 1.8; // Server failures have longest recovery
    
    // Check for SSO or hosting dependencies in primary impact
    const hasSsoProvider = primarySystems.some(s => s.connectionType === 'sso');
    const hasHostingProvider = primarySystems.some(s => s.connectionType === 'hosting');
    
    if (hasSsoProvider) recoveryTime *= 1.4; // SSO failures are complex to restore
    if (hasHostingProvider) recoveryTime *= 1.7; // Hosting failures take longest to recover
    
    // Round to nearest 0.5 hour
    return Math.round(recoveryTime * 2) / 2;
}

// Estimate user impact based on impact data
function estimateUserImpact(primarySystems, criticalityScore) {
    // Calculate user impact based on primary systems and overall criticality
    const totalImpact = primarySystems.reduce((sum, system) => sum + system.impact, 0);
    
    // Include criticality score in assessment
    const combinedScore = totalImpact + (criticalityScore * 0.2);
    
    if (combinedScore > 50 || primarySystems.some(s => s.connectionType === 'sso')) return "Critical";
    if (combinedScore > 35) return "High";
    if (combinedScore > 20) return "Medium";
    return "Low";
}

// Calculate recovery time for an individual system
function calculateSystemRecoveryTime(system) {
    // Base recovery time for a system in hours
    let recoveryTime = 1;
    
    // Adjust by system category
    switch (system.category.slug) {
        case 'core':
            recoveryTime = 4;
            break;
        case 'integration':
            recoveryTime = 3;
            break;
        case 'server':
            recoveryTime = 5;
            break;
        case 'custom':
            recoveryTime = 2.5;
            break;
        case 'external':
            recoveryTime = 2;
            break;
    }
    
    // Adjust by connection type
    if (system.connectionType === 'sso') {
        recoveryTime *= 1.3; // SSO connections take longer to recover
    } else if (system.connectionType === 'hosting') {
        recoveryTime *= 1.5; // Hosting dependencies are most complex
    }
    
    // Adjust by impact level (distance from source)
    // Primary impacts recover in parallel with source, others have dependencies
    if (system.impactLevel === 'primary') {
        // No adjustment needed
    } else if (system.impactLevel === 'secondary') {
        recoveryTime *= 0.8; // Less time after primary systems are back
    } else if (system.impactLevel === 'tertiary') {
        recoveryTime *= 0.6; // Even less time after secondaries are back
    } else {
        recoveryTime *= 0.4; // Minimal time for distant systems
    }
    
    // Factor in system impact score
    recoveryTime = recoveryTime * (0.8 + (system.impact / 20));
    
    // Round to 1 decimal place
    return Math.round(recoveryTime * 10) / 10;
}
 
// Updated dependency analysis function
async function improvedDependencyAnalysis(sourceSystemId) {
    console.log("Running corrected dependency analysis for system ID:", sourceSystemId);
    
    // Check if dependencyGraph exists, if not build it
    if (!dependencyGraph) {
        dependencyGraph = await buildCompleteGraph();
    }
    
    // Build an explicit dependency map that shows what systems are affected when another fails
    const dependentsMap = buildDependencyMap(dependencyGraph);
    
    // Get the source system for reference
    const sourceSystem = dependencyGraph.nodes[sourceSystemId];
    console.log(`Analyzing impact of failure for system: ${sourceSystemId} (${sourceSystem ? sourceSystem.name : 'Unknown'})`);
    
    // Track all systems that would be affected by a failure, organized by impact level
    const impactLevels = {
        0: [], // Source system (not displayed in results)
        1: [], // Primary impact (direct dependents)
        2: [], // Secondary impact
        3: [], // Tertiary impact
        4: []  // Quaternary impact and beyond
    };
    
    // To track visited nodes and their level
    const visited = new Map();
    visited.set(parseInt(sourceSystemId), 0); // Source system at level 0
    
    // LEVEL 1: Find systems that would be DIRECTLY affected if sourceSystemId fails
    const primarySystems = dependentsMap[sourceSystemId] || [];
    console.log("Primary systems (would be directly affected if source fails):", primarySystems);
    
    // Process primary systems
    const primaryImpacts = primarySystems.map(id => {
        const system = dependencyGraph.nodes[id];
        
        // Skip if system not found
        if (!system) {
            console.log(`System ${id} not found in dependency graph`);
            return null;
        }
        
        // CRITICAL FIX: DEBUG - Log if this system is in the source's dependencies
        if (dependencyGraph.dependencies[sourceSystemId] && 
            dependencyGraph.dependencies[sourceSystemId].includes(id)) {
            console.log(`System ${id} (${system.name}) is both a dependency of the source AND appears as dependent`);
            
            // This is expected in some cases - system A depends on B and B depends on A (bidirectional dependency)
            // We want to include this system if it's truly dependent on the source
        }
        
        // Determine connection type for primary impacts
        let connectionType = 'direct';
        
        // Check for SSO dependency - system depends on source for SSO
        if (system.sso_system && system.sso_system.id === parseInt(sourceSystemId)) {
            connectionType = 'sso';
            console.log(`System ${id} (${system.name}) depends on source for SSO`);
        } 
        // Check for hosting dependency - system depends on source for hosting
        else if (system.hosting_system && system.hosting_system.id === parseInt(sourceSystemId)) {
            connectionType = 'hosting';
            console.log(`System ${id} (${system.name}) depends on source for hosting`);
        }
        
        // Record this system as visited at level 1
        visited.set(parseInt(id), 1);
        
        // Calculate impact score
        const tierFactor = 1; // Primary impact
        const impact = calculateSystemImpact(system, tierFactor);
        
        // Return the impact data
        return {
            ...system,
            impact,
            impactLevel: 'primary',
            distanceFromSource: 1,
            connectionType,
            sourceNode: parseInt(sourceSystemId),
            path: [parseInt(sourceSystemId), parseInt(id)]
        };
    }).filter(Boolean); // Remove null entries
    
    // Add primary impacts to level 1
    impactLevels[1] = primaryImpacts;
    console.log("Primary impacts processed:", primaryImpacts.length);
    
    // LEVEL 2: For each primary impact, find systems that would be affected if it fails
    const secondaryImpacts = [];
    for (const primarySystem of primaryImpacts) {
        const primaryId = primarySystem.id;
        const secondaryDependents = dependentsMap[primaryId] || [];
        
        console.log(`Systems that would be affected if ${primarySystem.name} (ID: ${primaryId}) fails:`, secondaryDependents);
        
        for (const secondaryId of secondaryDependents) {
            // Skip if already visited at equal or higher level
            if (visited.has(parseInt(secondaryId)) && visited.get(parseInt(secondaryId)) <= 2) {
                continue;
            }
            
            const system = dependencyGraph.nodes[secondaryId];
            if (!system) continue;
            
            // Skip the original source system
            if (parseInt(secondaryId) === parseInt(sourceSystemId)) {
                continue;
            }
            
            // Mark as visited at level 2
            visited.set(parseInt(secondaryId), 2);
            
            const tierFactor = 0.8; // Secondary impact
            const impact = calculateSystemImpact(system, tierFactor);
            
            secondaryImpacts.push({
                ...system,
                impact,
                impactLevel: 'secondary',
                distanceFromSource: 2,
                connectionType: 'direct', // Default for secondary+
                sourceNode: parseInt(primaryId),
                path: [parseInt(sourceSystemId), parseInt(primaryId), parseInt(secondaryId)]
            });
        }
    }
    
    // Add secondary impacts to level 2
    impactLevels[2] = secondaryImpacts;
    console.log("Secondary impacts processed:", secondaryImpacts.length);
    
    // LEVEL 3: For each secondary impact, find systems that would be affected if it fails
    const tertiaryImpacts = [];
    for (const secondarySystem of secondaryImpacts) {
        const secondaryId = secondarySystem.id;
        const tertiaryDependents = dependentsMap[secondaryId] || [];
        
        console.log(`Systems that would be affected if ${secondarySystem.name} (ID: ${secondaryId}) fails:`, tertiaryDependents);
        
        for (const tertiaryId of tertiaryDependents) {
            // Skip if already visited at equal or higher level
            if (visited.has(parseInt(tertiaryId)) && visited.get(parseInt(tertiaryId)) <= 3) {
                continue;
            }
            
            const system = dependencyGraph.nodes[tertiaryId];
            if (!system) continue;
            
            // Skip the original source system and any systems already in the path
            if (parseInt(tertiaryId) === parseInt(sourceSystemId) || 
                secondarySystem.path.includes(parseInt(tertiaryId))) {
                continue;
            }
            
            // Mark as visited at level 3
            visited.set(parseInt(tertiaryId), 3);
            
            const tierFactor = 0.6; // Tertiary impact
            const impact = calculateSystemImpact(system, tierFactor);
            
            tertiaryImpacts.push({
                ...system,
                impact,
                impactLevel: 'tertiary',
                distanceFromSource: 3,
                connectionType: 'direct', // Default
                sourceNode: parseInt(secondaryId),
                path: [...secondarySystem.path, parseInt(tertiaryId)]
            });
        }
    }
    
    // Add tertiary impacts to level 3
    impactLevels[3] = tertiaryImpacts;
    console.log("Tertiary impacts processed:", tertiaryImpacts.length);
    
    // LEVEL 4: For each tertiary impact, find systems that would be affected if it fails
    const quaternaryImpacts = [];
    for (const tertiarySystem of tertiaryImpacts) {
        const tertiaryId = tertiarySystem.id;
        const quaternaryDependents = dependentsMap[tertiaryId] || [];
        
        console.log(`Systems that would be affected if ${tertiarySystem.name} (ID: ${tertiaryId}) fails:`, quaternaryDependents);
        
        for (const quaternaryId of quaternaryDependents) {
            // Skip if already visited at equal or higher level
            if (visited.has(parseInt(quaternaryId)) && visited.get(parseInt(quaternaryId)) <= 4) {
                continue;
            }
            
            const system = dependencyGraph.nodes[quaternaryId];
            if (!system) continue;
            
            // Skip systems already in the path
            if (tertiarySystem.path.includes(parseInt(quaternaryId))) {
                continue;
            }
            
            // Mark as visited at level 4
            visited.set(parseInt(quaternaryId), 4);
            
            const tierFactor = 0.4; // Quaternary impact
            const impact = calculateSystemImpact(system, tierFactor);
            
            quaternaryImpacts.push({
                ...system,
                impact,
                impactLevel: 'quaternary',
                distanceFromSource: 4,
                connectionType: 'direct', // Default
                sourceNode: parseInt(tertiaryId),
                path: [...tertiarySystem.path, parseInt(quaternaryId)]
            });
        }
    }
    
    // Add quaternary impacts to level 4
    impactLevels[4] = quaternaryImpacts;
    console.log("Quaternary impacts processed:", quaternaryImpacts.length);
    
    // Calculate criticality score
    let criticalityScore = 0;
    const levelFactors = [1, 1, 0.7, 0.5, 0.3];
    
    for (let level = 1; level <= 4; level++) {
        impactLevels[level].forEach(system => {
            criticalityScore += system.impact * levelFactors[level];
        });
    }
    
    // Calculate totals
    const systemsCount = impactLevels[1].length + impactLevels[2].length + 
                       impactLevels[3].length + impactLevels[4].length;
    
    // Sort each level by impact
    Object.values(impactLevels).forEach(systems => {
        systems.sort((a, b) => b.impact - a.impact);
    });
    
    console.log("Final impact levels:", impactLevels);
    
    return {
        primaryImpact: impactLevels[1],
        secondaryImpact: impactLevels[2],
        tertiaryImpact: impactLevels[3],
        quaternaryImpact: impactLevels[4],
        criticalityScore,
        systemsCount,
        recoveryTime: estimateRecoveryTime(impactLevels[1], impactLevels[2], impactLevels[3]),
        userImpact: estimateUserImpact(impactLevels[1], criticalityScore)
    };
}

// Generate improved impact paths with correct dependency direction
async function improvedImpactPaths(sourceSystemId) {
    console.log("Generating improved impact paths from source system:", sourceSystemId);
    
    // Check if dependencyGraph exists, if not build it
    if (!dependencyGraph) {
        dependencyGraph = await buildCompleteGraph();
    }
    
    // Get impact data if not already calculated
    if (!impactData) {
        impactData = await improvedDependencyAnalysis(sourceSystemId);
    }
    
    // Generate paths based on the impact data we already have
    const allPaths = [];
    let pathId = 1;
    
    // Helper function to convert an impact system to a path
    function createPathFromSystem(system) {
        if (!system.path) return null;
        
        // Create path using the stored path information
        const pathNodes = system.path.map(id => dependencyGraph.nodes[id]);
        
        // Prepare connections data
        const connections = [];
        for (let i = 0; i < system.path.length - 1; i++) {
            const sourceId = system.path[i];
            const targetId = system.path[i+1];
            
            // Determine connection type
            let connectionType = 'direct';
            
            // Check if target depends on source for SSO
            const targetSystem = dependencyGraph.nodes[targetId];
            if (targetSystem.sso_system && targetSystem.sso_system.id === parseInt(sourceId)) {
                connectionType = 'sso';
            } 
            // Check if target depends on source for hosting
            else if (targetSystem.hosting_system && targetSystem.hosting_system.id === parseInt(sourceId)) {
                connectionType = 'hosting';
            }
            
            connections.push({
                source: sourceId,
                target: targetId,
                type: connectionType
            });
        }
        
        return {
            id: pathId++,
            targetSystem: {
                ...system,
                impactLevel: system.impactLevel,
                impact: system.impact,
                distanceFromSource: system.distanceFromSource
            },
            path: pathNodes,
            connections: connections,
            length: system.path.length,
            impactScore: system.impact
        };
    }
    
    // Create paths for each level
    for (const primarySystem of impactData.primaryImpact) {
        const path = createPathFromSystem(primarySystem);
        if (path) allPaths.push(path);
    }
    
    for (const secondarySystem of impactData.secondaryImpact) {
        const path = createPathFromSystem(secondarySystem);
        if (path) allPaths.push(path);
    }
    
    for (const tertiarySystem of impactData.tertiaryImpact) {
        const path = createPathFromSystem(tertiarySystem);
        if (path) allPaths.push(path);
    }
    
    for (const quaternarySystem of impactData.quaternaryImpact) {
        const path = createPathFromSystem(quaternarySystem);
        if (path) allPaths.push(path);
    }
    
    // Sort paths by impact score
    allPaths.sort((a, b) => b.impactScore - a.impactScore);
    
    return allPaths;
}

// Populate the impacted systems by tier
function populateImpactedSystems(containerId, systems) {
    const container = document.getElementById(containerId);
    
    if (!container) return;
    
    // Clear existing content
    container.innerHTML = '';
    
    if (!systems || systems.length === 0) {
        container.innerHTML = '<div class="p-4 text-sm text-gray-500 text-center">No systems in this impact category</div>';
        return;
    }
    
    // Create a scrollable container if there are many systems
    const scrollContainer = document.createElement('div');
    scrollContainer.className = 'max-h-96 overflow-y-auto pr-1'; // Set max height and enable scrolling
    container.appendChild(scrollContainer);
    
    // Add each system to the container
    systems.forEach(system => {
        const systemItem = document.createElement('div');
        systemItem.className = 'p-4 hover:bg-gray-50 transition-colors border-b border-gray-100';
        
        let connectionType = '';
        if (system.connectionType === 'sso') {
            connectionType = '<span class="text-xs text-blue-600">SSO</span>';
        } else if (system.connectionType === 'hosting') {
            connectionType = '<span class="text-xs text-purple-600">Hosting</span>';
        }
        
        let sourceInfo = '';
        if (system.sourceNode && system.sourceNode !== currentSystemId) {
            // Find the source system name
            const sourceName = dependencyGraph.nodes[system.sourceNode]?.name || 'Unknown System';
            sourceInfo = `<div class="mt-1 text-xs text-gray-500">Dependent on: <a href="#" class="text-blue-600 view-source-btn" data-id="${system.sourceNode}">${sourceName}</a></div>`;
        }
        
        systemItem.innerHTML = `
            <div class="flex justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-900">${system.name}</h3>
                    <div class="flex items-center mt-1 space-x-2">
                        <span class="px-2 py-1 text-xs leading-5 font-semibold rounded-full"
                            style="background-color: ${system.category.color}; color: ${system.category.text_color}">
                            ${system.category.name}
                        </span>
                        ${connectionType ? `<span class="ml-2">${connectionType}</span>` : ''}
                    </div>
                    ${sourceInfo}
                </div>
                <div class="flex items-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        Impact: ${system.impact}
                    </span>
                </div>
            </div>
            <p class="mt-2 text-xs text-gray-500">
                ${system.vendor && system.vendor !== 'Unknown' ? `Vendor: ${system.vendor}` : ''}
                ${system.status ? `<br>Status: ${system.status.name}` : ''}
            </p>
            <div class="mt-2 flex justify-between">
                <div class="text-xs text-gray-600">
                    <span class="font-medium">Est. Recovery:</span> ${calculateSystemRecoveryTime(system)} hours
                </div>
                <a href="/systems/${system.id}/" class="text-xs text-blue-600 hover:text-blue-800">
                    View System Details
                </a>
            </div>
        `;
        
        scrollContainer.appendChild(systemItem);
    });
}

// Create a single path item for the impact paths view
function createPathItem(path, level) {
    const pathItem = document.createElement('div');
    pathItem.className = `impact-path path-level-${level} path-item`;
    pathItem.setAttribute('data-path-id', path.id);
    pathItem.setAttribute('data-impact-level', level);
    pathItem.setAttribute('data-path-length', path.length);
    pathItem.setAttribute('data-impact-score', path.impactScore);
    pathItem.setAttribute('data-target-system', path.targetSystem.id);
    
    // Track connection types
    const connectionTypes = path.connections.map(c => c.type);
    pathItem.setAttribute('data-connection-types', connectionTypes.join(','));
    
    // Create the header
    const header = document.createElement('div');
    header.className = `impact-path-header path-header-${level} flex justify-between items-center`;
    
    const targetSystem = path.targetSystem;
    
    header.innerHTML = `
        <div>
            <span class="font-medium">${targetSystem.name}</span>
            <span class="ml-2 text-xs px-2 py-0.5 rounded-full" style="background-color: ${targetSystem.category.color}; color: ${targetSystem.category.text_color}">
                ${targetSystem.category.name}
            </span>
        </div>
        <div class="flex items-center">
            <span class="text-xs mr-3">Path Length: ${path.length-1}</span>
            <span class="text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full">
                Impact Score: ${path.impactScore}
            </span>
        </div>
    `;
    
    pathItem.appendChild(header);
    
    // Create the body with dependency chain
    const body = document.createElement('div');
    body.className = 'impact-path-body';
    
    // Create dependency chain visualization
    const chain = document.createElement('div');
    chain.className = 'dependency-chain';
    
    // Add each system in the path with appropriate styling
    path.path.forEach((system, idx) => {
        // System node
        const systemNode = document.createElement('div');
        systemNode.className = `chain-node`;
        
        // Add special styling based on system type and position
        if (idx === 0) {
            // Source system (the one being analyzed)
            systemNode.style.backgroundColor = '#ffd700';
            systemNode.style.color = '#7c6900';
            systemNode.style.border = '1px solid #ff8c00';
        } else {
            // Affected systems based on level
            if (idx === path.path.length - 1) {
                // Target system (end of the path)
                const levelColors = {
                    primary: '#fee2e2',
                    secondary: '#ffedd5',
                    tertiary: '#fef9c3',
                    quaternary: '#dbeafe'
                };
                
                const levelTextColors = {
                    primary: '#b91c1c',
                    secondary: '#c2410c',
                    tertiary: '#854d0e',
                    quaternary: '#0369a1'
                };
                
                const levelBorders = {
                    primary: '#ef4444',
                    secondary: '#f97316',
                    tertiary: '#eab308',
                    quaternary: '#60a5fa'
                };
                
                systemNode.style.backgroundColor = levelColors[targetSystem.impactLevel] || levelColors.quaternary;
                systemNode.style.color = levelTextColors[targetSystem.impactLevel] || levelTextColors.quaternary;
                systemNode.style.border = `1px solid ${levelBorders[targetSystem.impactLevel] || levelBorders.quaternary}`;
            } else {
                // Intermediate node
                systemNode.style.backgroundColor = '#f3f4f6';
                systemNode.style.color = '#4b5563';
                systemNode.style.border = '1px solid #d1d5db';
            }
        }
        
        // Add system name
        systemNode.textContent = system.name;
        
        // Add connection badge if appropriate
        if (idx < path.path.length - 1) {
            const connection = path.connections.find(c => 
                c.source === system.id && c.target === path.path[idx + 1].id
            );
            
            if (connection && connection.type !== 'direct') {
                const badge = document.createElement('span');
                badge.className = `connection-type-badge connection-${connection.type}-badge`;
                badge.textContent = connection.type === 'sso' ? 'SSO' : 'Hosting';
                systemNode.appendChild(badge);
            }
        }
        
        chain.appendChild(systemNode);
        
        // Add arrow if not the last system
        if (idx < path.path.length - 1) {
            const arrow = document.createElement('div');
            arrow.className = 'chain-arrow';
            arrow.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            `;
            chain.appendChild(arrow);
        }
    });
    
    body.appendChild(chain);
    
    // Add view path button
    const viewButton = document.createElement('div');
    viewButton.className = 'mt-3 text-right';
    viewButton.innerHTML = `
        <a href="/systems/${targetSystem.id}/" class="inline-flex items-center px-2.5 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            View System Details
        </a>
    `;
    
    body.appendChild(viewButton);
    pathItem.appendChild(body);
    
    return pathItem;
}

// Populate the impact paths section
function populateImpactPaths(paths) {
    const container = document.getElementById('impact-paths-container');
    if (!container) return;
    
    // Clear existing content
    container.innerHTML = '';
    
    // Update total paths count
    const totalPathsCount = document.getElementById('totalPathsCount');
    if (totalPathsCount) {
        totalPathsCount.textContent = `${paths.length} paths identified`;
    }
    
    if (!paths || paths.length === 0) {
        container.innerHTML = `
            <div class="empty-state py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No impact paths found</h3>
                <p class="mt-1 text-sm text-gray-500">
                    No dependency chains were identified in the analysis.
                </p>
            </div>
        `;
        return;
    }
    
    // Group paths by impact level
    const groupedPaths = {
        primary: paths.filter(p => p.targetSystem.impactLevel === 'primary'),
        secondary: paths.filter(p => p.targetSystem.impactLevel === 'secondary'),
        tertiary: paths.filter(p => p.targetSystem.impactLevel === 'tertiary'),
        quaternary: paths.filter(p => p.targetSystem.impactLevel === 'quaternary')
    };
    
    // Create path items for each group
    ['primary', 'secondary', 'tertiary', 'quaternary'].forEach(level => {
        const levelPaths = groupedPaths[level];
        if (levelPaths.length === 0) return;
        
        const levelTitle = {
            primary: 'Primary Impact Paths (1 hop)',
            secondary: 'Secondary Impact Paths (2 hops)',
            tertiary: 'Tertiary Impact Paths (3 hops)',
            quaternary: 'Distant Impact Paths (4+ hops)'
        }[level];
        
        // Create section header
        const sectionDiv = document.createElement('div');
        sectionDiv.className = `impact-paths-section impact-level-${level}`;
        sectionDiv.innerHTML = `
            <h4 class="text-base font-medium text-gray-900 mb-2">${levelTitle} (${levelPaths.length})</h4>
            <div class="path-items space-y-3" id="path-items-${level}"></div>
        `;
        
        container.appendChild(sectionDiv);
        
        // Add paths to this section
        const pathItemsContainer = sectionDiv.querySelector(`#path-items-${level}`);
        levelPaths.forEach(path => {
            const pathItem = createPathItem(path, level);
            pathItemsContainer.appendChild(pathItem);
        });
    });
    
    // Initial filtering
    filterImpactPaths();
}

// Update the impact summary
function updateImpactSummary(impactData) {
    // Check if elements exist before trying to update them
    const totalAffectedEl = document.getElementById('total-affected-count');
    if (totalAffectedEl) {
        totalAffectedEl.textContent = `${impactData.systemsCount} systems affected`;
    }
    
    // Update the impact progress bar - scale to match the calculated criticality
    const progressEl = document.getElementById('impact-progress');
    if (progressEl) {
        const maxCriticality = 100; // Maximum possible criticality score for scaling
        const progressPercentage = Math.min(100, (impactData.criticalityScore / maxCriticality) * 100);
        progressEl.style.width = progressPercentage + "%";
    }
    
    // Update recovery metrics
    const systemsAffectedEl = document.getElementById('systems-affected');
    if (systemsAffectedEl) {
        systemsAffectedEl.textContent = impactData.systemsCount;
    }
    
    const recoveryTimeEl = document.getElementById('recovery-time');
    if (recoveryTimeEl) {
        recoveryTimeEl.textContent = impactData.recoveryTime <= 24 ? 
            `${impactData.recoveryTime} hours` : 
            `${Math.round(impactData.recoveryTime / 24)} days`;
    }
    
    const userImpactEl = document.getElementById('user-impact');
    if (userImpactEl) {
        userImpactEl.textContent = impactData.userImpact;
    }
}

// Filter functions for UI interactions

// Filter function for impact paths
function filterImpactPaths() {
    const impactLevel = document.getElementById('pathTypeFilter')?.value || 'all';
    const sortBy = document.getElementById('pathSortOrder')?.value || 'impact';
    const showDirect = document.getElementById('showDirectConnectionsPath')?.checked !== false;
    const showSSO = document.getElementById('showSSOConnectionsPath')?.checked !== false;
    const showHosting = document.getElementById('showHostingConnectionsPath')?.checked !== false;
    
    // Get all path items
    const allPaths = document.querySelectorAll('.path-item');
    
    allPaths.forEach(path => {
        // Get path attributes
        const pathLevel = path.getAttribute('data-impact-level');
        const connectionTypes = path.getAttribute('data-connection-types')?.split(',') || [];
        
        // Check if this path should be shown based on filters
        let showPath = true;
        
        // Filter by impact level
        if (impactLevel !== 'all' && pathLevel !== impactLevel) {
            showPath = false;
        }
        
        // Filter by connection types
        const hasDirectOnly = connectionTypes.every(type => type === 'direct');
        const hasSSO = connectionTypes.includes('sso');
        const hasHosting = connectionTypes.includes('hosting');
        
        if (
            (!showDirect && hasDirectOnly) ||
            (!showSSO && hasSSO) ||
            (!showHosting && hasHosting)
        ) {
            showPath = false;
        }
        
        // Show/hide this path
        path.style.display = showPath ? 'block' : 'none';
    });
    
    // Sort visible paths
    sortImpactPaths(sortBy);
}

// Sort function for impact paths
function sortImpactPaths(sortBy) {
    // Get all path sections
    const pathSections = document.querySelectorAll('.impact-paths-section');
    
    pathSections.forEach(section => {
        const pathItemsContainer = section.querySelector('.path-items');
        if (!pathItemsContainer) return;
        
        const pathItems = Array.from(pathItemsContainer.children);
        
        // Sort paths based on criteria
        pathItems.sort((a, b) => {
            if (sortBy === 'impact') {
                // Sort by impact score (highest first)
                return parseInt(b.getAttribute('data-impact-score') || 0) - 
                       parseInt(a.getAttribute('data-impact-score') || 0);
            } else if (sortBy === 'path-length') {
                // Sort by path length (shortest first)
                return parseInt(a.getAttribute('data-path-length') || 0) - 
                       parseInt(b.getAttribute('data-path-length') || 0);
            } else if (sortBy === 'alphabetical') {
                // Sort by system name (A-Z)
                const headerA = a.querySelector('.impact-path-header');
                const headerB = b.querySelector('.impact-path-header');
                const nameA = headerA ? headerA.innerText.trim().toLowerCase() : '';
                const nameB = headerB ? headerB.innerText.trim().toLowerCase() : '';
                return nameA.localeCompare(nameB);
            }
            return 0;
        });
        
        // Reappend sorted items
        pathItems.forEach(item => {
            pathItemsContainer.appendChild(item);
        });
    });
}

// Filter function for impact breakdown view
function filterImpactBreakdown() {
    const categoryFilter = document.getElementById('categoryFilter')?.value || 'all';
    const vendorFilter = document.getElementById('vendorFilter')?.value || 'all';
    const sortBy = document.getElementById('systemSort')?.value || 'impact';
    const showDirect = document.getElementById('showDirectConnections')?.checked !== false;
    const showSSO = document.getElementById('showSSOConnections')?.checked !== false;
    const showHosting = document.getElementById('showHostingConnections')?.checked !== false;
    
    // Get all system items across all impact tiers
    const allSystemItems = document.querySelectorAll('#primary-impact-systems > div > div, #secondary-impact-systems > div > div, #tertiary-impact-systems > div > div, #quaternary-impact-systems > div > div');
    
    allSystemItems.forEach(item => {
        // Skip the "No systems found" message
        if (item.classList.contains('text-center')) return;
        
        let showItem = true;
        
        // Filter by category if specified
        if (categoryFilter !== 'all') {
            const categoryBadge = item.querySelector('.rounded-full');
            if (categoryBadge && !categoryBadge.textContent.trim().toLowerCase().includes(categoryFilter.toLowerCase())) {
                showItem = false;
            }
        }
        
        // Filter by vendor if specified
        if (vendorFilter !== 'all') {
            const vendorText = item.textContent;
            if (!vendorText.includes(`Vendor: ${vendorFilter}`)) {
                showItem = false;
            }
        }
        
        // Filter by connection type
        const hasDirectText = !item.textContent.includes('SSO') && !item.textContent.includes('Hosting');
        const hasSSO = item.textContent.includes('SSO');
        const hasHosting = item.textContent.includes('Hosting');
        
        if (
            (!showDirect && hasDirectText) ||
            (!showSSO && hasSSO) ||
            (!showHosting && hasHosting)
        ) {
            showItem = false;
        }
        
        // Show/hide this item
        item.style.display = showItem ? 'block' : 'none';
    });
    
    // Handle empty containers by showing "No systems found" message
    ['primary-impact-systems', 'secondary-impact-systems', 'tertiary-impact-systems', 'quaternary-impact-systems'].forEach(containerId => {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const scrollContainer = container.querySelector('div');
        if (!scrollContainer) return;
        
        const visibleItems = Array.from(scrollContainer.children).filter(item => 
            !item.classList.contains('text-center') && item.style.display !== 'none'
        );
        
        // Find or create the "No systems found" message
        let noSystemsMsg = scrollContainer.querySelector('.text-center');
        
        if (visibleItems.length === 0) {
            if (!noSystemsMsg) {
                noSystemsMsg = document.createElement('div');
                noSystemsMsg.className = 'p-4 text-sm text-gray-500 text-center';
                noSystemsMsg.textContent = 'No systems found matching filters';
                scrollContainer.appendChild(noSystemsMsg);
            } else {
                noSystemsMsg.style.display = 'block';
            }
        } else if (noSystemsMsg) {
            noSystemsMsg.style.display = 'none';
        }
    });
    
    // Sort visible items in each container
    sortImpactBreakdown(sortBy);
}

// Sort function for impact breakdown view
function sortImpactBreakdown(sortBy) {
    ['primary-impact-systems', 'secondary-impact-systems', 'tertiary-impact-systems', 'quaternary-impact-systems'].forEach(containerId => {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const scrollContainer = container.querySelector('div');
        if (!scrollContainer) return;
        
        // Get all non-message items
        const items = Array.from(scrollContainer.children).filter(item => 
            !item.classList.contains('text-center')
        );
        
        // Sort based on criteria
        items.sort((a, b) => {
            if (sortBy === 'impact') {
                // Get impact scores
                const impactA = a.querySelector('.text-red-800')?.textContent.match(/\d+/) || [0];
                const impactB = b.querySelector('.text-red-800')?.textContent.match(/\d+/) || [0];
                return parseInt(impactB[0]) - parseInt(impactA[0]);
            } else if (sortBy === 'name') {
                // Sort by system name
                const nameA = a.querySelector('.font-medium')?.textContent.trim().toLowerCase() || '';
                const nameB = b.querySelector('.font-medium')?.textContent.trim().toLowerCase() || '';
                return nameA.localeCompare(nameB);
            } else if (sortBy === 'recovery') {
                // Sort by recovery time
                const recoveryA = a.querySelector('.text-gray-600')?.textContent.match(/[\d\.]+/) || [0];
                const recoveryB = b.querySelector('.text-gray-600')?.textContent.match(/[\d\.]+/) || [0];
                return parseFloat(recoveryB[0]) - parseFloat(recoveryA[0]);
            }
            return 0;
        });
        
        // Re-append items in sorted order
        items.forEach(item => {
            scrollContainer.appendChild(item);
        });
    });
}

// Main simulation function - converted to async
async function startSimulation() {
    console.log("Starting simulation...");
    
    // Show loading state
    const runDisasterSimulationBtn = document.getElementById('runDisasterSimulation');
    const runSimulationFromPlaceholderBtn = document.getElementById('runSimulationFromPlaceholder');
    const disasterSimulationResults = document.getElementById('disaster-simulation-results');
    const disasterSimulationPlaceholder = document.getElementById('disaster-simulation-placeholder');
    
    if (runDisasterSimulationBtn) {
        runDisasterSimulationBtn.disabled = true;
        runDisasterSimulationBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Running Simulation...
        `;
    }
    
    if (runSimulationFromPlaceholderBtn) {
        runSimulationFromPlaceholderBtn.disabled = true;
        runSimulationFromPlaceholderBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Running Simulation...
        `;
    }
    
    // Make sure disasterSimulationResults is visible before we try to update elements inside it
    if (disasterSimulationResults) {
        disasterSimulationResults.style.display = 'block';
    }
    
    if (disasterSimulationPlaceholder) {
        disasterSimulationPlaceholder.style.display = 'none';
    }
    
    try {
        // Perform analysis with async/await
        await performImprovedAnalysis();
        
        // Reset button
        if (runDisasterSimulationBtn) {
            runDisasterSimulationBtn.disabled = false;
            runDisasterSimulationBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Run Simulation
            `;
        }
        
        if (runSimulationFromPlaceholderBtn) {
            runSimulationFromPlaceholderBtn.disabled = false;
            runSimulationFromPlaceholderBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Run Simulation
            `;
        }
    } catch (error) {
        console.error("Error in simulation:", error);
        
        // Reset button
        if (runDisasterSimulationBtn) {
            runDisasterSimulationBtn.disabled = false;
            runDisasterSimulationBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Run Simulation
            `;
        }
        
        if (runSimulationFromPlaceholderBtn) {
            runSimulationFromPlaceholderBtn.disabled = false;
            runSimulationFromPlaceholderBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Run Simulation
            `;
        }
        
        // Show error message in the UI
        if (disasterSimulationResults) {
            disasterSimulationResults.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700">
                                Error running disaster simulation: ${error.message || "Unknown error"}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }
    }
}

// Updated improved analysis function that correctly traverses dependency chains
async function performImprovedAnalysis() {
    console.log("Starting improved disaster impact analysis...");
    
    // Build complete dependency graph with all relationships
    dependencyGraph = await buildCompleteGraph();
    console.log("Complete dependency graph built:", dependencyGraph);
    
    // Use improved analysis functions
    impactData = await improvedDependencyAnalysis(currentSystemId);
    console.log("Impact data generated:", impactData);
    
    completeImpactPaths = await improvedImpactPaths(currentSystemId);
    console.log("Impact paths generated:", completeImpactPaths);
    
    // Update UI
    updateImpactSummary(impactData);
    
    populateImpactedSystems('primary-impact-systems', impactData.primaryImpact);
    populateImpactedSystems('secondary-impact-systems', impactData.secondaryImpact);
    populateImpactedSystems('tertiary-impact-systems', impactData.tertiaryImpact);
    populateImpactedSystems('quaternary-impact-systems', impactData.quaternaryImpact);
    
    populateImpactPaths(completeImpactPaths);
    
    console.log("Improved disaster impact analysis completed.");
}

// Recovery step management functions
function editRecoveryStep(stepId) {
    // Fetch step details via AJAX
    fetch(`/systems/recovery-step/${stepId}/`)
        .then(response => response.json())
        .then(data => {
            // Fill form with step data
            document.getElementById('stepId').value = data.id;
            document.getElementById('stepTitle').value = data.title;
            document.getElementById('stepDescription').value = data.description;
            document.getElementById('responsibleTeam').value = data.responsible_team;
            document.getElementById('estimatedTime').value = data.estimated_time;
            
            // Update modal title
            document.getElementById('stepModalTitle').textContent = 'Edit Recovery Step';
            
            // Show modal
            document.getElementById('recoveryStepModal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error fetching step details:', error);
        });
}

function confirmDeleteStep(stepId) {
    // Set step ID in delete form
    document.getElementById('deleteStepId').value = stepId;
    
    // Update form action URL
    const deleteForm = document.getElementById('deleteStepForm');
    const systemId = currentSystemId;
    deleteForm.action = `/systems/${systemId}/recovery-step/${stepId}/delete/`;
    
    // Show modal
    document.getElementById('deleteStepModal').classList.remove('hidden');
}

function moveRecoveryStep(stepId, direction) {
    const systemId = currentSystemId;
    
    // Create request data
    const data = {
        step_id: stepId,
        direction: direction
    };
    
    // Send AJAX request
    fetch(`/systems/${systemId}/move-recovery-step/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            // Reload the page to show the updated order
            window.location.reload();
        } else {
            console.error('Error moving step:', response.statusText);
        }
    })
    .catch(error => {
        console.error('Error moving step:', error);
    });
}

// Helper function to get CSRF token
function getCsrfToken() {
    const elements = document.getElementsByName('csrfmiddlewaretoken');
    if (elements.length > 0) {
        return elements[0].value;
    }
    
    // Try to get from cookie
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith('csrftoken=')) {
            return cookie.substring('csrftoken='.length);
        }
    }
    
    return '';
}

// Document ready initialization
document.addEventListener('DOMContentLoaded', function() {
    // Setup filters for impact paths
    const pathTypeFilter = document.getElementById('pathTypeFilter');
    if (pathTypeFilter) {
        pathTypeFilter.addEventListener('change', filterImpactPaths);
    }
    
    const pathSortOrder = document.getElementById('pathSortOrder');
    if (pathSortOrder) {
        pathSortOrder.addEventListener('change', filterImpactPaths);
    }
    
    const showDirectConnectionsPath = document.getElementById('showDirectConnectionsPath');
    if (showDirectConnectionsPath) {
        showDirectConnectionsPath.addEventListener('change', filterImpactPaths);
    }
    
    const showSSOConnectionsPath = document.getElementById('showSSOConnectionsPath');
    if (showSSOConnectionsPath) {
        showSSOConnectionsPath.addEventListener('change', filterImpactPaths);
    }
    
    const showHostingConnectionsPath = document.getElementById('showHostingConnectionsPath');
    if (showHostingConnectionsPath) {
        showHostingConnectionsPath.addEventListener('change', filterImpactPaths);
    }
    
    // Setup filters for impact breakdown
    const categoryFilter = document.getElementById('categoryFilter');
    if (categoryFilter) {
        categoryFilter.addEventListener('change', filterImpactBreakdown);
    }
    
    const vendorFilter = document.getElementById('vendorFilter');
    if (vendorFilter) {
        vendorFilter.addEventListener('change', filterImpactBreakdown);
    }
    
    const systemSort = document.getElementById('systemSort');
    if (systemSort) {
        systemSort.addEventListener('change', filterImpactBreakdown);
    }
    
    const showDirectConnections = document.getElementById('showDirectConnections');
    if (showDirectConnections) {
        showDirectConnections.addEventListener('change', filterImpactBreakdown);
    }
    
    const showSSOConnections = document.getElementById('showSSOConnections');
    if (showSSOConnections) {
        showSSOConnections.addEventListener('change', filterImpactBreakdown);
    }
    
    const showHostingConnections = document.getElementById('showHostingConnections');
    if (showHostingConnections) {
        showHostingConnections.addEventListener('change', filterImpactBreakdown);
    }
    
    // Setup collapsible sections
    const impactPathsHeader = document.getElementById('impactPathsHeader');
    const impactPathsContent = document.getElementById('impactPathsContent');
    const impactBreakdownHeader = document.getElementById('impactBreakdownHeader');
    const impactBreakdownContent = document.getElementById('impactBreakdownContent');
    
    function toggleCollapsible(header, content) {
        header.classList.toggle('collapsed');
        content.classList.toggle('collapsed');
        
        // Update the arrow icon
        const arrow = header.querySelector('svg');
        if (header.classList.contains('collapsed')) {
            arrow.style.transform = 'rotate(-90deg)';
        } else {
            arrow.style.transform = 'rotate(0)';
        }
    }
    
    if (impactPathsHeader) {
        impactPathsHeader.addEventListener('click', function() {
            toggleCollapsible(this, impactPathsContent);
        });
    }
    
    if (impactBreakdownHeader) {
        impactBreakdownHeader.addEventListener('click', function() {
            toggleCollapsible(this, impactBreakdownContent);
        });
    }
    
    // Add run simulation button event listeners
    const runDisasterSimulationBtn = document.getElementById('runDisasterSimulation');
    if (runDisasterSimulationBtn) {
        runDisasterSimulationBtn.addEventListener('click', startSimulation);
    }
    
    const runSimulationFromPlaceholderBtn = document.getElementById('runSimulationFromPlaceholder');
    if (runSimulationFromPlaceholderBtn) {
        runSimulationFromPlaceholderBtn.addEventListener('click', startSimulation);
    }
});
</script>
{% endblock %}