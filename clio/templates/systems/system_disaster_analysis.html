<!-- templates/systems/system_disaster_analysis.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}Disaster Analysis for {{ system.name }} - Clio{% endblock %}

{% block extra_css %}
<style>
    /* Main Container Styles */
    .disaster-analysis-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    /* Impact Visualization Styles */
    .impact-visualization {
        position: relative;
        width: 100%;
        height: 600px;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        background-color: white;
        overflow: hidden;
    }
    
    .controls-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
        background-color: #f8fafc;
    }
    
    .controls-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .controls-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .viz-container {
        width: 100%;
        height: calc(100% - 60px);
        overflow: auto;
    }
    
    /* Impact Summary Styles */
    .impact-summary {
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .impact-summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .impact-summary-content {
        padding: 1rem;
    }
    
    .impact-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .stat-card {
        flex: 1 1 200px;
        background-color: #f8fafc;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
    }
    
    .stat-number {
        font-size: 1.875rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        color: #64748b;
        font-size: 0.875rem;
    }
    
    .system-list {
        margin-top: 1rem;
    }
    
    .system-list-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }
    
    .system-list-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
    }
    
    .system-list-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .system-list-table th {
        background-color: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .system-list-table th, .system-list-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
    }
    
    .system-list-table tr:last-child td {
        border-bottom: none;
    }
    
    /* Recovery Steps Styles */
    .recovery-steps {
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .recovery-steps-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .recovery-steps-content {
        padding: 1rem;
    }
    
    .steps-container {
        margin-top: 1rem;
    }
    
    .step-item {
        display: flex;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        margin-bottom: 0.75rem;
        background-color: white;
        overflow: hidden;
    }
    
    .step-order {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 3rem;
        background-color: #f8fafc;
        border-right: 1px solid #e2e8f0;
        font-weight: 600;
        color: #64748b;
    }
    
    .step-content {
        flex: 1;
        padding: 1rem;
    }
    
    .step-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .step-title {
        font-weight: 600;
    }
    
    .step-metadata {
        font-size: 0.875rem;
        color: #64748b;
    }
    
    .step-description {
        margin-bottom: 0.5rem;
        color: #334155;
    }
    
    .step-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    /* Node and Edge Styles for Graph */
    .node circle {
        stroke-width: 2px;
        cursor: pointer;
    }
    
    .node text {
        font-size: 12px;
        fill: #1e293b;
        pointer-events: none;
        text-anchor: middle;
    }
    
    .node.source circle {
        fill: #ef4444;
        stroke: #b91c1c;
    }
    
    .node.level-1 circle {
        fill: #f97316;
        stroke: #c2410c;
    }
    
    .node.level-2 circle {
        fill: #eab308;
        stroke: #a16207;
    }
    
    .node.level-3-plus circle {
        fill: #facc15;
        stroke: #ca8a04;
    }
    
    .node.unaffected circle {
        fill: #cbd5e1;
        stroke: #64748b;
    }
    
    .edge {
        stroke: #cbd5e1;
        stroke-width: 1.5px;
        fill: none;
    }
    
    .edge.affected {
        stroke: #ef4444;
        stroke-width: 2px;
    }
    
    /* Button Styles */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .btn-icon {
        padding: 0.5rem;
    }
    
    .btn-primary {
        background-color: #3b82f6;
        color: white;
        border: 1px solid #2563eb;
    }
    
    .btn-primary:hover {
        background-color: #2563eb;
    }
    
    .btn-secondary {
        background-color: white;
        color: #0f172a;
        border: 1px solid #cbd5e1;
    }
    
    .btn-secondary:hover {
        background-color: #f8fafc;
    }
    
    .btn-danger {
        background-color: #ef4444;
        color: white;
        border: 1px solid #dc2626;
    }
    
    .btn-danger:hover {
        background-color: #dc2626;
    }
    
    /* Badge Styles */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    /* Modal Styles */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
    }
    
    .modal-backdrop.show {
        opacity: 1;
        visibility: visible;
    }
    
    .modal {
        width: 100%;
        max-width: 500px;
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transform: scale(0.95);
        opacity: 0;
        transition: transform 0.2s, opacity 0.2s;
    }
    
    .modal-backdrop.show .modal {
        transform: scale(1);
        opacity: 1;
    }
    
    .modal-header {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .modal-title {
        font-weight: 600;
        font-size: 1.125rem;
    }
    
    .modal-close {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.25rem;
        color: #64748b;
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .modal-footer {
        padding: 1rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    /* Legend Style */
    .legend-container {
        position: absolute;
        top: 70px;
        right: 10px;
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 0.75rem;
        z-index: 20;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .legend-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.375rem;
        font-size: 0.75rem;
    }
    
    .legend-item:last-child {
        margin-bottom: 0;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        margin-right: 0.5rem;
        border-radius: 50%;
        border: 1px solid #e2e8f0;
    }
    
    /* Form Styles */
    .recovery-form-container {
        margin-top: 1rem;
    }
    
    .recovery-form {
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8fafc;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.375rem;
        font-weight: 500;
    }
    
    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #cbd5e1;
        border-radius: 0.25rem;
        background-color: white;
    }
    
    textarea.form-control {
        min-height: 100px;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block page_header %}
<div class="md:flex md:items-center md:justify-between">
    <div class="flex-1 min-w-0">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
            Disaster Analysis for {{ system.name }}
        </h2>
    </div>
    <div class="mt-4 flex md:mt-0 md:ml-4">
        <a href="{% url 'systems:detail' system.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Back to System Details
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="disaster-analysis-container">
    <!-- System Overview -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="sm:col-span-2">
                    <div class="mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">System Overview</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">Key information about the system</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Name</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ system.name }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Category</dt>
                            <dd class="mt-1 text-sm">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background-color: {{ system.category.color }}; color: {{ system.category.text_color }}">
                                    {{ system.category.name }}
                                </span>
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Status</dt>
                            <dd class="mt-1 text-sm">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background-color: {{ system.status.color }}; color: {{ system.status.text_color }}">
                                    {{ system.status.name }}
                                </span>
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Vendor</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ system.vendor|default:"Not specified" }}</dd>
                        </div>
                        {% if system.hosting_system %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Hosting System</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <a href="{% url 'systems:detail' system.hosting_system.pk %}" class="text-blue-600 hover:text-blue-900">
                                    {{ system.hosting_system.name }}
                                </a>
                            </dd>
                        </div>
                        {% endif %}
                        {% if system.sso_system %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">SSO System</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <a href="{% url 'systems:detail' system.sso_system.pk %}" class="text-blue-600 hover:text-blue-900">
                                    {{ system.sso_system.name }}
                                </a>
                            </dd>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <div class="mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Administrators</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">People responsible for this system</p>
                    </div>
                    {% if administrators %}
                    <ul class="divide-y divide-gray-200">
                        {% for admin in administrators %}
                        <li class="py-2 flex items-center">
                            <div class="flex-shrink-0">
                                <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-500">
                                    {{ admin.user.first_name|first|upper }}{{ admin.user.last_name|first|upper }}
                                </span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">{{ admin.user.get_full_name }}</p>
                                {% if admin.is_primary %}
                                <p class="text-xs text-blue-700">Primary Administrator</p>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-sm text-gray-500">No administrators assigned</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Impact Visualization -->
    <div class="impact-visualization">
        <div class="controls-container">
            <div class="controls-left">
                <h3 class="text-lg font-medium">Downstream Impact Analysis</h3>
                <div>
                    <label for="depth-control" class="text-sm text-gray-600 mr-2">Impact Depth:</label>
                    <select id="depth-control" class="text-sm border border-gray-300 rounded px-2 py-1">
                        <option value="1">Direct Dependencies</option>
                        <option value="2">Two Levels</option>
                        <option value="3">Three Levels</option>
                        <option value="0" selected>All Levels</option>
                    </select>
                </div>
            </div>
            <div class="controls-right">
                <button id="reset-zoom" class="btn btn-sm btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 16 16">
                        <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                        <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                    </svg>
                    Reset View
                </button>
                <button id="optimize-layout" class="btn btn-sm btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 16 16">
                        <path d="M2.5 3.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-11zm2-2a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM0 13a1.5 1.5 0 0 0 1.5 1.5h13A1.5 1.5 0 0 0 16 13V6a1.5 1.5 0 0 0-1.5-1.5h-13A1.5 1.5 0 0 0 0 6v7zm1.5.5A.5.5 0 0 1 1 13V6a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13z"/>
                    </svg>
                    Optimize Layout
                </button>
                <button id="zoom-in" class="btn btn-sm btn-icon btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 7.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V12a.5.5 0 0 1-1 0v-1.5H6a.5.5 0 0 1 0-1h1.5V8a.5.5 0 0 1 .5-.5z"/>
                        <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/>
                    </svg>
                </button>
                <button id="zoom-out" class="btn btn-sm btn-icon btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 7.5a.5.5 0 0 1 .5.5v1.5h1.5a.5.5 0 0 1 0 1h-3.5a.5.5 0 0 1 0-1H8V8a.5.5 0 0 1 .5-.5z"/>
                        <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="viz-container" id="impact-graph"></div>
        
        <!-- Legend for visualization -->
        <div class="legend-container">
            <div class="legend-title">Legend</div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ef4444;"></div>
                <span>Source System (Outage)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f97316;"></div>
                <span>Directly Affected Systems</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #eab308;"></div>
                <span>Indirectly Affected Systems</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #cbd5e1;"></div>
                <span>Unaffected Systems</span>
            </div>
        </div>
    </div>

    <!-- Impact Summary -->
    <div class="impact-summary">
        <div class="impact-summary-header">
            <h3 class="text-lg font-medium">Impact Summary</h3>
            <button id="export-report" class="btn btn-sm btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Export Report
            </button>
        </div>
        <div class="impact-summary-content">
            <div class="impact-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-affected">-</div>
                    <div class="stat-label">Total Affected Systems</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="direct-affected">-</div>
                    <div class="stat-label">Directly Affected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="indirect-affected">-</div>
                    <div class="stat-label">Indirectly Affected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="max-depth">-</div>
                    <div class="stat-label">Maximum Impact Depth</div>
                </div>
            </div>
            
            <div class="system-list">
                <h4 class="system-list-title">Affected Systems</h4>
                <div class="system-list-container">
                    <table class="system-list-table" id="affected-systems-table">
                        <thead>
                            <tr>
                                <th width="40%">System Name</th>
                                <th width="25%">Category</th>
                                <th width="20%">Vendor</th>
                                <th width="15%">Impact Level</th>
                            </tr>
                        </thead>
                        <tbody id="affected-systems-body">
                            <tr>
                                <td colspan="4" class="text-center py-4 text-gray-500">Loading affected systems...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recovery Steps -->
    <div class="recovery-steps">
        <div class="recovery-steps-header">
            <h3 class="text-lg font-medium">Disaster Recovery Steps</h3>
            <button id="add-step-btn" class="btn btn-sm btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Add Step
            </button>
        </div>
        <div class="recovery-steps-content">
            {% if recovery_steps %}
            <div class="steps-container" id="recovery-steps-container">
                {% for step in recovery_steps %}
                <div class="step-item" id="step-{{ step.id }}" data-order="{{ step.order }}">
                    <div class="step-order">{{ step.order }}</div>
                    <div class="step-content">
                        <div class="step-header">
                            <h4 class="step-title">{{ step.title }}</h4>
                            <div class="step-metadata">
                                {% if step.estimated_time %}
                                <span class="badge" style="background-color: #e0f2fe; color: #0369a1">
                                    Est. Time: {{ step.estimated_time }}
                                </span>
                                {% endif %}
                                {% if step.responsible_team %}
                                <span class="ml-2 text-gray-600">Resp: {{ step.responsible_team }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="step-description">{{ step.description }}</div>
                        <div class="step-actions">
                            {% if not forloop.first %}
                            <button class="btn btn-sm btn-icon btn-secondary move-step" data-direction="up" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>
                                </svg>
                            </button>
                            {% endif %}
                            {% if not forloop.last %}
                            <button class="btn btn-sm btn-icon btn-secondary move-step" data-direction="down" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>
                                </svg>
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-icon btn-secondary edit-step" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-icon btn-danger delete-step" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="mx-auto mb-4 text-gray-400" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                </svg>
                <p class="text-lg">No recovery steps defined yet</p>
                <p class="mt-2">Click the "Add Step" button to create your disaster recovery plan</p>
            </div>
            {% endif %}
            
            <!-- Recovery step form (initially hidden) -->
            <div class="recovery-form-container" id="recovery-form-container" style="display: none;">
                <form id="recovery-step-form" method="post" action="{% url 'systems:save_recovery_step' system.pk %}" class="recovery-form">
                    {% csrf_token %}
                    <input type="hidden" name="step_id" id="step_id">
                    <div class="form-group">
                        <label for="title" class="form-label">Step Title</label>
                        <input type="text" id="title" name="title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="description" class="form-label">Description</label>
                        <textarea id="description" name="description" class="form-control" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="responsible_team" class="form-label">Responsible Team/Person</label>
                        <input type="text" id="responsible_team" name="responsible_team" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="estimated_time" class="form-label">Estimated Time to Complete</label>
                        <input type="text" id="estimated_time" name="estimated_time" class="form-control" placeholder="e.g. 30 minutes, 2 hours">
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancel-step-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Step</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for step deletion confirmation -->
<div class="modal-backdrop" id="delete-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Deletion</h3>
            <button type="button" class="modal-close" id="close-delete-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this recovery step? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-delete">Cancel</button>
            <form method="post" id="delete-step-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Core variables
    var sourceSystemId = {{ system.id }};
    var sourceSystemName = "{{ system.name }}";
    var systemDetailUrl = "{% url 'systems:detail' 0 %}";
    
    // Get API data for dependencies
    fetch('{% url "systems:get_affected_systems" pk=system.pk %}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error("API Error:", data.error);
                return;
            }
            
            // Update summary statistics
            var totalAffected = data.affected_systems.length;
            var directlyAffected = data.affected_systems.filter(s => s.impact_level === 1).length;
            var indirectlyAffected = totalAffected - directlyAffected;
            var maxDepth = data.affected_systems.length > 0 ? Math.max(...data.affected_systems.map(s => s.impact_level)) : 0;
            
            document.getElementById('total-affected').textContent = totalAffected;
            document.getElementById('direct-affected').textContent = directlyAffected;
            document.getElementById('indirect-affected').textContent = indirectlyAffected;
            document.getElementById('max-depth').textContent = maxDepth;
            
            // Populate affected systems table
            populateAffectedSystemsTable(data.affected_systems);
            
            // Create visualization
            createVisualization(data);
        })
        .catch(error => {
            console.error("Error fetching affected systems:", error);
            document.getElementById('impact-graph').innerHTML = 
                '<div class="flex items-center justify-center h-full">' +
                '<div class="text-center p-6 bg-red-50 rounded-lg">' +
                '<h3 class="text-lg font-medium text-red-800">Error Loading Data</h3>' +
                '<p class="mt-2 text-red-600">Could not load dependency data: ' + error.message + '</p>' +
                '</div>' +
                '</div>';
        });
    
    // Populate affected systems table
    function populateAffectedSystemsTable(systems) {
        var tableBody = document.getElementById('affected-systems-body');
        
        if (systems.length === 0) {
            tableBody.innerHTML = 
                '<tr>' +
                '<td colspan="4" class="text-center py-4 text-gray-500">' +
                'No affected systems found. This system is not a dependency for any other system.' +
                '</td>' +
                '</tr>';
            return;
        }
        
        var tableHtml = '';
        
        systems.forEach(function(system) {
            var impactLevel = system.impact_level === 1 ? "Direct" : "Indirect (L" + system.impact_level + ")";
            var impactClass = system.impact_level === 1 ? "bg-orange-100 text-orange-800" : "bg-yellow-100 text-yellow-800";
            
            tableHtml += 
                '<tr>' +
                '<td>' +
                '<a href="' + systemDetailUrl.replace('0', system.id) + '" class="text-blue-600 hover:underline">' +
                system.name +
                '</a>' +
                '</td>' +
                '<td>' +
                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" ' + 
                'style="background-color: ' + (system.category && system.category.color ? system.category.color : '#f2f2f2') + 
                '; color: ' + (system.category && system.category.text_color ? system.category.text_color : '#333333') + '">' +
                (system.category ? system.category.name : 'Unknown') +
                '</span>' +
                '</td>' +
                '<td>' + (system.vendor || "N/A") + '</td>' +
                '<td>' +
                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + impactClass + '">' +
                impactLevel +
                '</span>' +
                '</td>' +
                '</tr>';
        });
        
        tableBody.innerHTML = tableHtml;
    }
    
    // Create simple visualization using D3.js
    function createVisualization(data) {
        var container = document.getElementById('impact-graph');
        var width = container.clientWidth;
        var height = container.clientHeight;
        
        // Prepare data for visualization
        var nodes = [];
        var links = [];
        
        // Add source system
        nodes.push({
            id: data.source_system.id,
            name: data.source_system.name,
            category: data.source_system.category,
            vendor: data.source_system.vendor,
            impact_level: 0,
            isSource: true
        });
        
        // Add affected systems
        data.affected_systems.forEach(function(system) {
            nodes.push({
                id: system.id,
                name: system.name,
                category: system.category,
                vendor: system.vendor,
                impact_level: system.impact_level,
                isSource: false
            });
            
            // Create links from impact paths
            var path = system.impact_path;
            if (path && path.length > 1) {
                for (var i = 0; i < path.length - 1; i++) {
                    links.push({
                        source: path[i],
                        target: path[i + 1]
                    });
                }
            }
        });
        
        // Create SVG
        var svg = d3.select('#impact-graph')
            .append('svg')
            .attr('width', width)
            .attr('height', height);
            
        // Add zoom behavior
        var zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on('zoom', function(event) {
                g.attr('transform', event.transform);
            });
            
        svg.call(zoom);
        
        // Create a group for all elements
        var g = svg.append('g');
        
        // Create links with curved paths
        var link = g.selectAll('.edge')
            .data(links)
            .enter()
            .append('path')
            .attr('class', 'edge affected')
            .attr('id', function(d) {
                return 'edge-' + d.source + '-' + d.target;
            });
            
        // Create arrow markers
        svg.append('defs').append('marker')
            .attr('id', 'arrow')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 28) // Adjusted for circular nodes
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#ef4444');
            
        link.attr('marker-end', 'url(#arrow)');
        
        // Create node groups
        var node = g.selectAll('.node')
            .data(nodes)
            .enter()
            .append('g')
            .attr('class', function(d) {
                var classes = 'node';
                if (d.isSource) {
                    classes += ' source';
                } else if (d.impact_level === 1) {
                    classes += ' level-1';
                } else if (d.impact_level === 2) {
                    classes += ' level-2';
                } else if (d.impact_level > 2) {
                    classes += ' level-3-plus';
                } else {
                    classes += ' unaffected';
                }
                return classes;
            })
            .attr('id', function(d) { return 'node-' + d.id; });
            
        // Add circular nodes
        var circleRadius = 25;
        node.append('circle')
            .attr('r', circleRadius);
            
        // Add node labels
        node.append('text')
            .attr('dy', '.35em')
            .text(function(d) { return d.name; })
            .each(function(d) {
                // Truncate text if too long
                var textElement = d3.select(this);
                var maxWidth = 40;
                var text = d.name;
                
                while (this.getComputedTextLength() > maxWidth && text.length > 3) {
                    text = text.slice(0, -1);
                    textElement.text(text + '...');
                }
            });
            
        // Create simulation
        var simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(links).id(function(d) { return d.id; }).distance(150))
            .force('charge', d3.forceManyBody().strength(-500))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(50))
            .on('tick', ticked);
            
        // Simulation tick function
        function ticked() {
            // Update links with curved paths
            link.attr('d', function(d) {
                var sourceNode = nodes.find(n => n.id === d.source.id || n.id === d.source);
                var targetNode = nodes.find(n => n.id === d.target.id || n.id === d.target);
                
                if (!sourceNode || !targetNode) return '';
                
                var sourceX = sourceNode.x;
                var sourceY = sourceNode.y;
                var targetX = targetNode.x;
                var targetY = targetNode.y;
                
                // Calculate the total distance
                var dx = targetX - sourceX;
                var dy = targetY - sourceY;
                var dist = Math.sqrt(dx * dx + dy * dy);
                
                // If distance is too small, return a small line
                if (dist < 1) {
                    return 'M' + sourceX + ',' + sourceY + 'L' + (sourceX + 1) + ',' + (sourceY + 1);
                }
                
                // Calculate offsets to account for node size
                var offsetX = (dx * circleRadius) / dist;
                var offsetY = (dy * circleRadius) / dist;
                
                // Start and end points with offsets
                var startX = sourceX + offsetX;
                var startY = sourceY + offsetY;
                var endX = targetX - offsetX;
                var endY = targetY - offsetY;
                
                // Calculate control points for a curved path
                var curveFactor = Math.min(dist * 0.2, 40); // Scale curve based on distance
                
                // Calculate the midpoint
                var mpx = (startX + endX) / 2;
                var mpy = (startY + endY) / 2;
                
                // Calculate the control point offset perpendicular to the line
                var cpx = mpx - dy * (curveFactor / dist);
                var cpy = mpy + dx * (curveFactor / dist);
                
                // Create a quadratic bezier curve path
                return 'M' + startX + ',' + startY + ' Q' + cpx + ',' + cpy + ' ' + endX + ',' + endY;
            });
            
            // Update node positions
            node.attr('transform', function(d) {
                return 'translate(' + d.x + ',' + d.y + ')';
            });
        }
        
        // Center the view on the source node
        setTimeout(function() {
            var sourceNode = nodes.find(n => n.isSource);
            if (sourceNode && sourceNode.x && sourceNode.y) {
                var transform = d3.zoomIdentity
                    .translate(width / 2 - sourceNode.x, height / 2 - sourceNode.y);
                
                svg.transition()
                    .duration(750)
                    .call(zoom.transform, transform);
            }
        }, 100);
        
        // Control buttons
        document.getElementById('reset-zoom').addEventListener('click', function() {
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity);
        });
        
        document.getElementById('optimize-layout').addEventListener('click', function() {
            // Release fixed positions
            nodes.forEach(function(node) {
                node.fx = null;
                node.fy = null;
            });
            
            // Apply stronger forces
            simulation
                .force('charge', d3.forceManyBody().strength(-1000))
                .force('link', d3.forceLink(links).id(function(d) { return d.id; }).distance(200))
                .force('collision', d3.forceCollide().radius(60));
            
            // Restart with high alpha
            simulation.alpha(1).restart();
        });
        
        document.getElementById('zoom-in').addEventListener('click', function() {
            svg.transition().duration(300).call(zoom.scaleBy, 1.2);
        });
        
        document.getElementById('zoom-out').addEventListener('click', function() {
            svg.transition().duration(300).call(zoom.scaleBy, 0.8);
        });
        
        // Depth filter
        document.getElementById('depth-control').addEventListener('change', function() {
            var depthLimit = parseInt(this.value);
            
            // If depth is 0 (all levels), show all nodes
            if (depthLimit === 0) {
                node.style('display', null);
                link.style('display', null);
                return;
            }
            
            // Hide all nodes and links first
            node.style('display', 'none');
            link.style('display', 'none');
            
            // Always show source node
            d3.select('.node.source').style('display', null);
            
            // Show affected systems up to the specified depth
            node.filter(function(d) {
                return d.impact_level > 0 && d.impact_level <= depthLimit;
            }).style('display', null);
            
            // Show corresponding links
            var visibleNodeIds = new Set();
            
            // Add the source node and nodes within the depth limit
            visibleNodeIds.add(sourceSystemId);
            node.filter(function(d) {
                return d.impact_level > 0 && d.impact_level <= depthLimit;
            }).each(function(d) {
                visibleNodeIds.add(d.id);
            });
            
            // Show links connecting visible nodes
            link.filter(function(d) {
                var sourceId = d.source.id || d.source;
                var targetId = d.target.id || d.target;
                return visibleNodeIds.has(sourceId) && visibleNodeIds.has(targetId);
            }).style('display', null);
        });
    }
    
    // =============================
    // Recovery Step Management
    // =============================
    
    // Add step button
    document.getElementById('add-step-btn').addEventListener('click', function() {
        showStepForm();
    });
    
    // Cancel step button
    document.getElementById('cancel-step-btn').addEventListener('click', function() {
        hideStepForm();
    });
    
    // Show step form
    function showStepForm() {
        // Reset form
        document.getElementById('recovery-step-form').reset();
        document.getElementById('step_id').value = '';
        
        // Show form
        document.getElementById('recovery-form-container').style.display = 'block';
        document.getElementById('title').focus();
    }
    
    // Hide step form
    function hideStepForm() {
        document.getElementById('recovery-form-container').style.display = 'none';
    }
    
    // Edit step handlers
    document.querySelectorAll('.edit-step').forEach(function(button) {
        button.addEventListener('click', function() {
            const stepId = this.getAttribute('data-step-id');
            editStep(stepId);
        });
    });
    
    // Delete step handlers
    document.querySelectorAll('.delete-step').forEach(function(button) {
        button.addEventListener('click', function() {
            const stepId = this.getAttribute('data-step-id');
            confirmDeleteStep(stepId);
        });
    });
    
    // Move step handlers
    document.querySelectorAll('.move-step').forEach(function(button) {
        button.addEventListener('click', function() {
            const stepId = this.getAttribute('data-step-id');
            const direction = this.getAttribute('data-direction');
            moveStep(stepId, direction);
        });
    });
    
    // Edit step function
    function editStep(stepId) {
        // Fetch step data
        fetch('{% url "systems:get_recovery_step" step_id=0 %}'.replace('0', stepId))
            .then(response => response.json())
            .then(data => {
                // Fill form
                document.getElementById('step_id').value = data.id;
                document.getElementById('title').value = data.title;
                document.getElementById('description').value = data.description;
                document.getElementById('responsible_team').value = data.responsible_team;
                document.getElementById('estimated_time').value = data.estimated_time;
                
                // Show form
                showStepForm();
            })
            .catch(error => {
                console.error('Error fetching step data:', error);
                alert('Error loading step data. Please try again.');
            });
    }
    
    // Delete step confirmation
    function confirmDeleteStep(stepId) {
        // Update delete form action
        const deleteForm = document.getElementById('delete-step-form');
        deleteForm.action = '{% url "systems:delete_recovery_step" system_pk=system.pk step_id=0 %}'.replace('0', stepId);
        
        // Show modal
        document.getElementById('delete-modal').classList.add('show');
    }
    
    // Cancel delete handlers
    document.getElementById('close-delete-modal').addEventListener('click', function() {
        document.getElementById('delete-modal').classList.remove('show');
    });
    
    document.getElementById('cancel-delete').addEventListener('click', function() {
        document.getElementById('delete-modal').classList.remove('show');
    });
    
    // Move step function
    function moveStep(stepId, direction) {
        // Send request to move step
        fetch('{% url "systems:move_recovery_step" system.pk %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                step_id: stepId,
                direction: direction
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload page to show updated order
                window.location.reload();
            } else {
                alert('Error moving step: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error moving step:', error);
            alert('Error moving step. Please try again.');
        });
    }
    
    // Basic PDF export
    document.getElementById('export-report').addEventListener('click', function() {
        alert('PDF export is not implemented in this simplified version.');
    });
});
</script>
{% endblock %}