{% extends "base.html" %}
<script src="https://d3js.org/d3.v7.min.js"></script>

{% block title %}Disaster Impact Analysis - {{ system.name }} - Clio{% endblock %}

{% block extra_css %}
<style>
    /* Base styling for impact badges */
    .impact-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
    }
    
    .impact-badge-primary {
        background-color: #fee2e2;
        color: #b91c1c;
    }
    
    .impact-badge-secondary {
        background-color: #ffedd5;
        color: #c2410c;
    }
    
    .impact-badge-tertiary {
        background-color: #fef9c3;
        color: #854d0e;
    }
    
    .impact-badge-quaternary {
        background-color: #e0f2fe;
        color: #0369a1;
    }
    
    /* Graph visualization styles */
    #diagram-container {
        position: relative;
        width: 100%;
        height: 600px;
        margin-bottom: 20px;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    #disaster-graph {
        width: 100%;
        height: 100%;
        background-color: #f9fafb;
    }
    
    .system-node {
        stroke-width: 2px;
        cursor: pointer;
    }
    
    .system-label {
        font-size: 10px;
        text-anchor: middle;
        pointer-events: none;
        font-weight: normal;
    }
    
    .main-system .system-label {
        font-weight: bold;
    }
    
    .label-background {
        fill: white;
        fill-opacity: 0.8;
        stroke: #ddd;
        stroke-width: 0.5;
    }
    
    .connection {
        stroke: #999;
        stroke-width: 1.5px;
        fill: none;
        marker-end: url(#arrowhead);
    }
    
    .connection-direct {
        stroke-dasharray: none;
    }
    
    .connection-sso {
        stroke-dasharray: 5, 3;
    }
    
    .connection-hosting {
        stroke-dasharray: 1, 3;
    }
    
    .connection-highlighted {
        stroke: #ff5722;
        stroke-width: 2.5px;
    }
    
    .highlighted {
        stroke-width: 3px;
        stroke: #ff5722;
    }

    /* Legend styling */
    .legend {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column;
        padding: 8px;
        background-color: white;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        z-index: 10;
        max-width: 180px;
    }
    
    .legend-title {
        font-weight: 600;
        margin-bottom: 8px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        margin-right: 8px;
        border-radius: 3px;
    }
    
    /* Info panel styling */
    #infoPanel {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background-color: white;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        max-width: 300px;
        display: none;
        z-index: 10;
        max-height: 400px;
        overflow-y: auto;
    }
    
    /* Zoom controls */
    .zoom-controls {
        position: absolute;
        right: 20px;
        top: 160px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        z-index: 10;
    }
    
    .zoom-controls button {
        display: block;
        width: 34px;
        height: 34px;
        background-color: white;
        border: none;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        font-size: 18px;
        padding: 0;
        text-align: center;
    }
    
    .zoom-controls button:last-child {
        border-bottom: none;
    }
    
    .zoom-controls button:hover {
        background-color: #f5f5f5;
    }
    
    /* Loading indicator */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        font-size: 18px;
        font-weight: bold;
        color: #4285f4;
    }
    
    .spinner {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid rgba(66, 133, 244, 0.3);
        border-radius: 50%;
        border-top-color: #4285f4;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Path visualization */
    .failure-path {
        stroke: #ef4444;
        stroke-width: 3px;
        fill: none;
        stroke-dasharray: none;
        pointer-events: none;
        stroke-linecap: round;
        animation: pathPulse 2s infinite;
    }
    
    @keyframes pathPulse {
        0% { stroke-opacity: 1; }
        50% { stroke-opacity: 0.6; }
        100% { stroke-opacity: 1; }
    }
    
    /* Better empty state */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem;
        text-align: center;
    }
    
    .empty-state svg {
        color: #9ca3af;
        margin-bottom: 1rem;
    }
    
    /* Controls panel */
    .controls-panel {
        margin-bottom: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .control-button {
        padding: 0.5rem 1rem;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }
    
    .control-button:hover {
        background-color: #f9fafb;
    }
    
    .control-button.active {
        background-color: #ef4444;
        border-color: #dc2626;
        color: white;
    }
    
    /* Recovery step styling */
    .recovery-step {
        position: relative;
        border-left: 4px solid #3b82f6;
        padding-left: 1.5rem;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .recovery-step-number {
        position: absolute;
        left: -1.25rem;
        top: -0.25rem;
        height: 2.5rem;
        width: 2.5rem;
        background-color: #3b82f6;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 640px) {
        #diagram-container {
            height: 400px;
        }
        
        .legend {
            max-width: 140px;
            font-size: 0.75rem;
        }
        
        #infoPanel {
            max-width: 250px;
        }
    }
</style>
{% endblock %}

{% block page_header %}
<div class="md:flex md:items-center md:justify-between">
    <div class="flex-1 min-w-0">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
            Disaster Impact Analysis: {{ system.name }}
        </h2>
        <div class="mt-1 flex flex-col sm:flex-row sm:flex-wrap sm:mt-0 sm:space-x-6">
            <div class="mt-2 flex items-center text-sm text-gray-500">
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                      style="background-color: {{ system.category.color }}; color: {{ system.category.text_color }}">
                    {{ system.category.name }}
                </span>
            </div>
            <div class="mt-2 flex items-center text-sm text-gray-500">
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                      style="background-color: {{ system.status.color }}; color: {{ system.status.text_color }}">
                    {{ system.status.name }}
                </span>
            </div>
        </div>
    </div>
    <div class="mt-4 flex md:mt-0 md:ml-4">
        <button id="runDisasterSimulation" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Run Simulation
        </button>
        <a href="{% url 'systems:detail' system.id %}" class="ml-3 inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Back to System
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 bg-amber-50">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-amber-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-md leading-6 font-medium text-gray-900">
                    Failure Impact Assessment
                </h3>
                <p class="mt-1 text-sm text-gray-500">
                    This analysis shows the cascading impact of a failure in {{ system.name }}. The visualization displays dependency relationships and failure propagation paths.
                </p>
            </div>
        </div>
    </div>
    
    <div class="border-t border-gray-200">
        <div id="disaster-simulation-results" class="px-4 py-5 sm:p-6 hidden">
            <div class="mb-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-base font-medium text-gray-900">Impact Summary</h3>
                    <span id="total-affected-count" class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"></span>
                </div>
                <div class="mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="impact-progress" class="bg-red-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Visualization controls -->
            <div class="controls-panel">
                <button type="button" id="resetViewButton" class="control-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Reset View
                </button>
                <button type="button" id="optimizeLayoutButton" class="control-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    Optimize Layout
                </button>
                <button type="button" id="showFullPathButton" class="control-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    Show Full Paths
                </button>
                <button type="button" id="toggleIntermediateButton" class="control-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                    Hide Intermediate
                </button>
                <button type="button" id="toggleHostingButton" class="control-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                    </svg>
                    Show Hosting
                </button>
                <button type="button" id="toggleSsoButton" class="control-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    Show SSO
                </button>
            </div>
            
            <!-- Dependency Graph Visualization -->
            <div id="diagram-container" style="width: 100%; min-height: 600px;">
                <div id="disaster-graph"></div>
                
                <!-- Legend -->
                <div class="legend">
                    <div class="legend-title">Impact Legend</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffd700; border: 1px solid #ff8c00;"></div>
                        <span>Current System</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #fee2e2; border: 1px solid #ef4444;"></div>
                        <span>Primary Impact</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffedd5; border: 1px solid #f97316;"></div>
                        <span>Secondary Impact</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #fef9c3; border: 1px solid #eab308;"></div>
                        <span>Tertiary Impact</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e0f2fe; border: 1px solid #0ea5e9;"></div>
                        <span>SSO Dependency</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f3e8ff; border: 1px solid #a855f7;"></div>
                        <span>Hosting Dependency</span>
                    </div>
                </div>
                
                <!-- Zoom controls -->
                <div class="zoom-controls">
                    <button id="zoomInButton" title="Zoom In">+</button>
                    <button id="zoomOutButton" title="Zoom Out">−</button>
                    <button id="fitViewButton" title="Fit All">⌂</button>
                </div>
                
                <!-- Info panel -->
                <div id="infoPanel">
                    <h3 id="infoPanelTitle" class="text-lg font-medium mb-2"></h3>
                    <div id="infoPanelContent"></div>
                </div>
                
                <!-- Loading overlay -->
                <div class="loading-overlay">
                    <div class="spinner"></div>
                    <span>Analyzing failure impact...</span>
                </div>
            </div>
            
            <!-- Impact Metrics -->
            <div class="mt-8 grid grid-cols-1 gap-5 sm:grid-cols-4">
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Systems Affected
                            </dt>
                            <dd id="systems-affected" class="mt-1 text-3xl font-semibold text-gray-900">
                                --
                            </dd>
                        </dl>
                    </div>
                </div>
                
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Estimated Recovery Time
                            </dt>
                            <dd id="recovery-time" class="mt-1 text-3xl font-semibold text-gray-900">
                                --
                            </dd>
                        </dl>
                    </div>
                </div>
                
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                User Impact Estimate
                            </dt>
                            <dd id="user-impact" class="mt-1 text-3xl font-semibold text-gray-900">
                                --
                            </dd>
                        </dl>
                    </div>
                </div>
                
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Business Impact
                            </dt>
                            <dd id="business-impact" class="mt-1 text-3xl font-semibold text-gray-900">
                                --
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
            
            <!-- Impact Lists -->
            <div class="mt-8">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Impact Breakdown</h3>
                
                <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
                    <!-- Primary Impact (Tier 1) -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                        <div class="px-4 py-5 sm:px-6 bg-red-50">
                            <h4 class="text-base font-medium text-red-700 flex items-center">
                                <span class="inline-block w-3 h-3 bg-red-700 rounded-full mr-2"></span>
                                Primary Impact Systems
                            </h4>
                        </div>
                        <div class="border-t border-gray-200">
                            <div id="primary-impact-systems" class="divide-y divide-gray-200">
                                <!-- Will be populated by JavaScript -->
                                <div class="p-4 text-sm text-gray-500 text-center">No systems found</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Secondary Impact (Tier 2) -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                        <div class="px-4 py-5 sm:px-6 bg-orange-50">
                            <h4 class="text-base font-medium text-orange-700 flex items-center">
                                <span class="inline-block w-3 h-3 bg-orange-600 rounded-full mr-2"></span>
                                Secondary Impact Systems
                            </h4>
                        </div>
                        <div class="border-t border-gray-200">
                            <div id="secondary-impact-systems" class="divide-y divide-gray-200">
                                <!-- Will be populated by JavaScript -->
                                <div class="p-4 text-sm text-gray-500 text-center">No systems found</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tertiary Impact (Tier 3) -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                        <div class="px-4 py-5 sm:px-6 bg-yellow-50">
                            <h4 class="text-base font-medium text-yellow-700 flex items-center">
                                <span class="inline-block w-3 h-3 bg-yellow-600 rounded-full mr-2"></span>
                                Tertiary Impact Systems
                            </h4>
                        </div>
                        <div class="border-t border-gray-200">
                            <div id="tertiary-impact-systems" class="divide-y divide-gray-200">
                                <!-- Will be populated by JavaScript -->
                                <div class="p-4 text-sm text-gray-500 text-center">No systems found</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="disaster-simulation-placeholder" class="px-4 py-12 sm:p-6 text-center">
            <div class="empty-state">
                <svg class="h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No simulation results</h3>
                <p class="mt-1 text-sm text-gray-500">
                    Click "Run Simulation" to analyze the potential impact of a failure in this system.
                </p>
                <div class="mt-6">
                    <button type="button" id="runSimulationFromPlaceholder" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Run Simulation
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Disaster Recovery Plan -->
<div class="mt-6 bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
        <div>
            <h4 class="text-md leading-6 font-medium text-gray-900">
                Disaster Recovery Plan
            </h4>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">
                Step-by-step recovery process in case of system failure.
            </p>
        </div>
        <button id="addRecoveryStepBtn" class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
            Add Step
        </button>
    </div>
    <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
        <div id="recovery-steps-container" class="space-y-6">
            {% if recovery_steps %}
                {% for step in recovery_steps %}
                <div class="recovery-step relative border-l-4 border-blue-600 pl-4 py-2" data-step-id="{{ step.id }}">
                    <div class="absolute -left-5 -top-1 h-10 w-10 rounded-full bg-blue-600 flex items-center justify-center">
                        <span class="text-xs font-medium text-white">{{ step.order }}</span>
                    </div>
                    <div class="flex justify-between items-start ml-4">
                        <div>
                            <h5 class="text-sm font-medium text-gray-900">{{ step.title }}</h5>
                            <p class="mt-1 text-sm text-gray-500">{{ step.description|linebreaksbr }}</p>
                            
                            {% if step.responsible_team or step.estimated_time %}
                            <div class="mt-2 flex space-x-4 text-xs text-gray-500">
                                {% if step.responsible_team %}
                                <div>
                                    <span class="font-medium">Team:</span> {{ step.responsible_team }}
                                </div>
                                {% endif %}
                                
                                {% if step.estimated_time %}
                                <div>
                                    <span class="font-medium">Est. Time:</span> {{ step.estimated_time }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" class="text-blue-600 hover:text-blue-900 edit-step" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button type="button" class="text-red-600 hover:text-red-900 delete-step" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                            {% if not forloop.first %}
                            <button type="button" class="text-gray-600 hover:text-gray-900 move-step-up" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </button>
                            {% endif %}
                            {% if not forloop.last %}
                            <button type="button" class="text-gray-600 hover:text-gray-900 move-step-down" data-step-id="{{ step.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div id="empty-recovery-steps" class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No recovery steps</h3>
                    <p class="mt-1 text-sm text-gray-500">
                        Start by adding the first step to your disaster recovery plan.
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recovery Step Modal -->
<div id="recoveryStepModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4" id="stepModalTitle">Add Recovery Step</h3>
        <form id="recoveryStepForm" method="post" action="{% url 'systems:save_recovery_step' system.id %}">
            {% csrf_token %}
            <input type="hidden" name="step_id" id="stepId" value="">
            
            <div class="mb-4">
                <label for="stepTitle" class="block text-sm font-medium text-gray-700">Title</label>
                <input type="text" id="stepTitle" name="title" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
            </div>
            
            <div class="mb-4">
                <label for="stepDescription" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="stepDescription" name="description" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required></textarea>
            </div>
            
            <div class="mb-4">
                <label for="responsibleTeam" class="block text-sm font-medium text-gray-700">Responsible Team</label>
                <input type="text" id="responsibleTeam" name="responsible_team" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            
            <div class="mb-4">
                <label for="estimatedTime" class="block text-sm font-medium text-gray-700">Estimated Time</label>
                <input type="text" id="estimatedTime" name="estimated_time" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g. 30 minutes, 2 hours">
            </div>
            
            <div class="mt-5 sm:mt-6 flex justify-end space-x-3">
                <button type="button" id="cancelStepModal" class="inline-flex justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </button>
                <button type="submit" class="inline-flex justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Step Confirmation Modal -->
<div id="deleteStepModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Remove Recovery Step</h3>
        <p class="text-sm text-gray-500 mb-4">
            Are you sure you want to remove this recovery step from the plan? This action cannot be undone.
        </p>
        <form id="deleteStepForm" method="post" action="{% url 'systems:delete_recovery_step' system.id 0 %}">
            {% csrf_token %}
            <input type="hidden" name="step_id" id="deleteStepId" value="">
            
            <div class="mt-5 sm:mt-6 flex justify-end space-x-3">
                <button type="button" id="cancelDeleteStep" class="inline-flex justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </button>
                <button type="submit" class="inline-flex justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Remove
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    let dependencyGraph = null;
    let impactData = null;
    let simulation = null;
    let zoomInstance = null;
    let showFullPaths = false;
    let hideIntermediateNodes = false;
    let showHostingDependencies = true;
    let showSsoDependencies = true;
    
    // Get DOM elements
    const runDisasterSimulationBtn = document.getElementById('runDisasterSimulation');
    const runSimulationFromPlaceholderBtn = document.getElementById('runSimulationFromPlaceholder');
    const disasterSimulationResults = document.getElementById('disaster-simulation-results');
    const disasterSimulationPlaceholder = document.getElementById('disaster-simulation-placeholder');
    
    // Visualization control buttons
    const resetViewButton = document.getElementById('resetViewButton');
    const optimizeLayoutButton = document.getElementById('optimizeLayoutButton');
    const showFullPathButton = document.getElementById('showFullPathButton');
    const toggleIntermediateButton = document.getElementById('toggleIntermediateButton');
    const toggleHostingButton = document.getElementById('toggleHostingButton');
    const toggleSsoButton = document.getElementById('toggleSsoButton');
    
    // Zoom control buttons
    const zoomInButton = document.getElementById('zoomInButton');
    const zoomOutButton = document.getElementById('zoomOutButton');
    const fitViewButton = document.getElementById('fitViewButton');
    
    // Recovery step buttons
    const addRecoveryStepBtn = document.getElementById('addRecoveryStepBtn');
    const cancelStepModalBtn = document.getElementById('cancelStepModal');
    const cancelDeleteStepBtn = document.getElementById('cancelDeleteStep');
    
    // Add event listeners
    if (runDisasterSimulationBtn) {
        runDisasterSimulationBtn.addEventListener('click', startSimulation);
    }
    
    if (runSimulationFromPlaceholderBtn) {
        runSimulationFromPlaceholderBtn.addEventListener('click', startSimulation);
    }
    
    if (resetViewButton) {
        resetViewButton.addEventListener('click', resetView);
    }
    
    if (optimizeLayoutButton) {
        optimizeLayoutButton.addEventListener('click', optimizeLayout);
    }
    
    if (showFullPathButton) {
        showFullPathButton.addEventListener('click', toggleFullPath);
    }
    
    if (toggleIntermediateButton) {
        toggleIntermediateButton.addEventListener('click', toggleIntermediate);
    }
    
    if (toggleHostingButton) {
        toggleHostingButton.addEventListener('click', toggleHosting);
    }
    
    if (toggleSsoButton) {
        toggleSsoButton.addEventListener('click', toggleSso);
    }
    
    if (zoomInButton) {
        zoomInButton.addEventListener('click', zoomIn);
    }
    
    if (zoomOutButton) {
        zoomOutButton.addEventListener('click', zoomOut);
    }
    
    if (fitViewButton) {
        fitViewButton.addEventListener('click', fitAllNodes);
    }
    
    // Recovery step event listeners
    if (addRecoveryStepBtn) {
        addRecoveryStepBtn.addEventListener('click', function() {
            openRecoveryStepModal();
        });
    }
    
    if (cancelStepModalBtn) {
        cancelStepModalBtn.addEventListener('click', function() {
            closeRecoveryStepModal();
        });
    }
    
    if (cancelDeleteStepBtn) {
        cancelDeleteStepBtn.addEventListener('click', function() {
            document.getElementById('deleteStepModal').classList.add('hidden');
        });
    }
    
    // Attach event listeners to dynamic elements
    function attachDynamicEventListeners() {
        // Edit step buttons
        document.querySelectorAll('.edit-step').forEach(function(button) {
            button.addEventListener('click', function() {
                const stepId = this.getAttribute('data-step-id');
                editRecoveryStep(stepId);
            });
        });
        
        // Delete step buttons
        document.querySelectorAll('.delete-step').forEach(function(button) {
            button.addEventListener('click', function() {
                const stepId = this.getAttribute('data-step-id');
                confirmDeleteStep(stepId);
            });
        });
        
        // Move step up buttons
        document.querySelectorAll('.move-step-up').forEach(function(button) {
            button.addEventListener('click', function() {
                const stepId = this.getAttribute('data-step-id');
                moveRecoveryStep(stepId, 'up');
            });
        });
        
        // Move step down buttons
        document.querySelectorAll('.move-step-down').forEach(function(button) {
            button.addEventListener('click', function() {
                const stepId = this.getAttribute('data-step-id');
                moveRecoveryStep(stepId, 'down');
            });
        });
    }
    
    // Call this initially to set up existing buttons
    attachDynamicEventListeners();
    
    // Function to start the simulation
    function startSimulation() {
        // Show loading state
        runDisasterSimulationBtn.disabled = true;
        runDisasterSimulationBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Running Simulation...
        `;
        
        if (runSimulationFromPlaceholderBtn) {
            runSimulationFromPlaceholderBtn.disabled = true;
            runSimulationFromPlaceholderBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Running Simulation...
            `;
        }
        
        // Simulate delay for better UX
        setTimeout(function() {
            performDisasterImpactAnalysis();
            
            // Update UI
            disasterSimulationPlaceholder.style.display = 'none';
            disasterSimulationResults.style.display = 'block';
            const forceReflow = document.body.offsetHeight;
            
            // Reset button
            runDisasterSimulationBtn.disabled = false;
            runDisasterSimulationBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Run Simulation
            `;
            
            if (runSimulationFromPlaceholderBtn) {
                runSimulationFromPlaceholderBtn.disabled = false;
                runSimulationFromPlaceholderBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Run Simulation
                `;
            }
        }, 1000);
    }
    
    // Perform the impact analysis
    function performDisasterImpactAnalysis() {
        // Get current system information
        const systemId = {{ system.id }};
        const systemName = "{{ system.name }}";
        const systemCategory = "{{ system.category.slug }}";
        const systemCategoryName = "{{ system.category.name }}";
        
        // Build a complete dependency graph from the relationship data
        dependencyGraph = buildDependencyGraph();
        
        // Calculate impact tiers based on dependency graph traversal
        impactData = calculateImpactTiers(systemId, dependencyGraph);
        
        // Update the impact summary
        updateImpactSummary(impactData);
        
        // Create the dependency graph visualization
        createDependencyVisualization(systemId, dependencyGraph, impactData);
        
        // Populate the impacted systems by tier
        populateImpactedSystems('primary-impact-systems', impactData.primaryImpact);
        populateImpactedSystems('secondary-impact-systems', impactData.secondaryImpact);
        populateImpactedSystems('tertiary-impact-systems', impactData.tertiaryImpact);
        
        // Update recovery metrics
        updateRecoveryMetrics(systemCategory, impactData);
    }
    
    // Update recovery metrics based on impact data
    function updateRecoveryMetrics(systemCategory, impactData) {
        // Update the recovery time display
        document.getElementById('recovery-time').textContent = 
            impactData.recoveryTime <= 24 ? 
            `${impactData.recoveryTime} hours` : 
            `${Math.round(impactData.recoveryTime / 24)} days`;
            
        // Update user impact display
        document.getElementById('user-impact').textContent = impactData.userImpact;
        
        // Update business impact display
        document.getElementById('business-impact').textContent = impactData.businessImpact;
        
        // Update systems affected count
        document.getElementById('systems-affected').textContent = impactData.systemsCount;
    }
    
    // Build a complete dependency graph from system relationships
    function buildDependencyGraph() {
        // Create a graph structure to hold all systems and their relationships
        const graph = {
            nodes: {},         // All system nodes
            dependencies: {},  // Outgoing edges from each node (what this system depends on)
            dependents: {},    // Incoming edges to each node (what depends on this system)
            ssoRelations: {},  // Track SSO relationships
            hostingRelations: {} // Track hosting relationships
        };
        
        // First, add all systems we know about to the graph
        const allSystems = [];
        
        // Add the current system
        const currentSystem = {
            id: {{ system.id }},
            name: "{{ system.name }}",
            category: {
                slug: "{{ system.category.slug }}",
                name: "{{ system.category.name }}",
                color: "{{ system.category.color }}",
                text_color: "{{ system.category.text_color }}"
            },
            status: {
                slug: "{{ system.status.slug }}",
                name: "{{ system.status.name }}",
                color: "{{ system.status.color }}",
                text_color: "{{ system.status.text_color }}"
            },
            vendor: "{{ system.vendor|default:'Unknown' }}"
        };
        
        allSystems.push(currentSystem);
        
        // Add all systems that this system depends on
        {% for dep in dependencies %}
        allSystems.push({
            id: {{ dep.id }},
            name: "{{ dep.name }}",
            category: {
                slug: "{{ dep.category.slug }}",
                name: "{{ dep.category.name }}",
                color: "{{ dep.category.color }}",
                text_color: "{{ dep.category.text_color }}"
            },
            status: {
                slug: "{{ dep.status.slug }}",
                name: "{{ dep.status.name }}",
                color: "{{ dep.status.color }}",
                text_color: "{{ dep.status.text_color }}"
            },
            vendor: "{{ dep.vendor|default:'Unknown' }}"
        });
        {% endfor %}
        
        // Add all systems that depend on this system
        {% for dep in dependents %}
        allSystems.push({
            id: {{ dep.id }},
            name: "{{ dep.name }}",
            category: {
                slug: "{{ dep.category.slug }}",
                name: "{{ dep.category.name }}",
                color: "{{ dep.category.color }}",
                text_color: "{{ dep.category.text_color }}"
            },
            status: {
                slug: "{{ dep.status.slug }}",
                name: "{{ dep.status.name }}",
                color: "{{ dep.status.color }}",
                text_color: "{{ dep.status.text_color }}"
            },
            vendor: "{{ dep.vendor|default:'Unknown' }}"
        });
        {% endfor %}
        
        // Remove duplicate systems by ID
        const systemIds = new Set();
        const uniqueSystems = allSystems.filter(system => {
            if (systemIds.has(system.id)) {
                return false;
            }
            systemIds.add(system.id);
            return true;
        });
        
        // Add all systems to the graph
        uniqueSystems.forEach(system => {
            graph.nodes[system.id] = system;
            graph.dependencies[system.id] = [];
            graph.dependents[system.id] = [];
        });
        
        // Add direct dependencies based on the dependencies list
        {% for dep in dependencies %}
        if (!graph.dependencies[{{ system.id }}].includes({{ dep.id }})) {
            graph.dependencies[{{ system.id }}].push({{ dep.id }});
        }
        if (!graph.dependents[{{ dep.id }}].includes({{ system.id }})) {
            graph.dependents[{{ dep.id }}].push({{ system.id }});
        }
        {% endfor %}
        
        // Add direct dependents based on the dependents list
        {% for dep in dependents %}
        if (!graph.dependencies[{{ dep.id }}].includes({{ system.id }})) {
            graph.dependencies[{{ dep.id }}].push({{ system.id }});
        }
        if (!graph.dependents[{{ system.id }}].includes({{ dep.id }})) {
            graph.dependents[{{ system.id }}].push({{ dep.id }});
        }
        {% endfor %}

        // Add SSO and hosting relationships - important for complete path visualization
        {% if system.sso_system %}
        graph.ssoRelations[{{ system.id }}] = {{ system.sso_system.id }};
        // Add to graph.nodes if not already there
        if (!graph.nodes[{{ system.sso_system.id }}]) {
            graph.nodes[{{ system.sso_system.id }}] = {
                id: {{ system.sso_system.id }},
                name: "{{ system.sso_system.name }}",
                category: {
                    slug: "{{ system.sso_system.category.slug }}",
                    name: "{{ system.sso_system.category.name }}",
                    color: "{{ system.sso_system.category.color }}",
                    text_color: "{{ system.sso_system.category.text_color }}"
                },
                status: {
                    slug: "{{ system.sso_system.status.slug }}",
                    name: "{{ system.sso_system.status.name }}",
                    color: "{{ system.sso_system.status.color }}",
                    text_color: "{{ system.sso_system.status.text_color }}"
                },
                vendor: "{{ system.sso_system.vendor|default:'Unknown' }}",
                isSsoProvider: true
            };
            graph.dependencies[{{ system.sso_system.id }}] = [];
            graph.dependents[{{ system.sso_system.id }}] = [];
        }
        if (!graph.dependencies[{{ system.id }}].includes({{ system.sso_system.id }})) {
            graph.dependencies[{{ system.id }}].push({{ system.sso_system.id }});
        }
        if (!graph.dependents[{{ system.sso_system.id }}].includes({{ system.id }})) {
            graph.dependents[{{ system.sso_system.id }}].push({{ system.id }});
        }
        {% endif %}
        
        {% if system.hosting_system %}
        graph.hostingRelations[{{ system.id }}] = {{ system.hosting_system.id }};
        // Add to graph.nodes if not already there
        if (!graph.nodes[{{ system.hosting_system.id }}]) {
            graph.nodes[{{ system.hosting_system.id }}] = {
                id: {{ system.hosting_system.id }},
                name: "{{ system.hosting_system.name }}",
                category: {
                    slug: "{{ system.hosting_system.category.slug }}",
                    name: "{{ system.hosting_system.category.name }}",
                    color: "{{ system.hosting_system.category.color }}",
                    text_color: "{{ system.hosting_system.category.text_color }}"
                },
                status: {
                    slug: "{{ system.hosting_system.status.slug }}",
                    name: "{{ system.hosting_system.status.name }}",
                    color: "{{ system.hosting_system.status.color }}",
                    text_color: "{{ system.hosting_system.status.text_color }}"
                },
                vendor: "{{ system.hosting_system.vendor|default:'Unknown' }}",
                isHostingProvider: true
            };
            graph.dependencies[{{ system.hosting_system.id }}] = [];
            graph.dependents[{{ system.hosting_system.id }}] = [];
        }
        if (!graph.dependencies[{{ system.id }}].includes({{ system.hosting_system.id }})) {
            graph.dependencies[{{ system.id }}].push({{ system.hosting_system.id }});
        }
        if (!graph.dependents[{{ system.hosting_system.id }}].includes({{ system.id }})) {
            graph.dependents[{{ system.hosting_system.id }}].push({{ system.id }});
        }
        {% endif %}
        
        // Make sure all relationships are properly propagated
        // This is critical to ensure non-first level dependencies are correctly tracked
        const processedLinks = new Set();
        
        function ensureDependencyLinks(sourceId, targetId, connectionType) {
            const linkKey = `${sourceId}-${targetId}`;
            if (processedLinks.has(linkKey)) return;
            processedLinks.add(linkKey);
            
            // Make sure both nodes exist
            if (!graph.nodes[sourceId] || !graph.nodes[targetId]) return;
            
            // Add the dependency in both directions
            if (!graph.dependencies[sourceId].includes(targetId)) {
                graph.dependencies[sourceId].push(targetId);
            }
            if (!graph.dependents[targetId].includes(sourceId)) {
                graph.dependents[targetId].push(sourceId);
            }
            
            // If this is an SSO or hosting relationship, track it
            if (connectionType === 'sso') {
                graph.ssoRelations[sourceId] = targetId;
            } else if (connectionType === 'hosting') {
                graph.hostingRelations[sourceId] = targetId;
            }
        }
        
        // Process all relationships from the server data
        {% for dep in dependencies %}
        ensureDependencyLinks({{ system.id }}, {{ dep.id }}, 'direct');
        {% endfor %}
        
        {% for dep in dependents %}
        ensureDependencyLinks({{ dep.id }}, {{ system.id }}, 'direct');
        {% endfor %}
        
        {% if system.sso_system %}
        ensureDependencyLinks({{ system.id }}, {{ system.sso_system.id }}, 'sso');
        {% endif %}
        
        {% if system.hosting_system %}
        ensureDependencyLinks({{ system.id }}, {{ system.hosting_system.id }}, 'hosting');
        {% endif %}
        
        {% if sso_dependents %}
        {% for sso_dep in sso_dependents %}
        ensureDependencyLinks({{ sso_dep.id }}, {{ system.id }}, 'sso');
        {% endfor %}
        {% endif %}
        
        {% if hosted_systems %}
        {% for hosted in hosted_systems %}
        ensureDependencyLinks({{ hosted.id }}, {{ system.id }}, 'hosting');
        {% endfor %}
        {% endif %}
        
        return graph;
    }
    
    // Calculate impact tiers based on the dependency graph
    function calculateImpactTiers(systemId, dependencyGraph) {
    console.log("Calculating impact tiers for system ID:", systemId);
    console.log("Dependency graph:", dependencyGraph);
    
    // Map for impact level names
    const impactLevelMap = {
        0: 'primary',    // Was "critical"
        1: 'secondary',  // Was "high"
        2: 'tertiary',   // Was "medium"
        3: 'quaternary', // Fourth level
        4: 'quinary'     // Fifth level
    };
    
    // Initialize impact arrays for each tier
    const primaryImpact = [];
    const secondaryImpact = [];
    const tertiaryImpact = [];
    const quaternaryImpact = [];
    
    // Track visited nodes to prevent duplicates
    const visitedNodes = new Set([systemId]); // Mark the source system as visited
    
    // Track overall impact score
    let criticalityScore = 0;
    
    // BFS approach for level-by-level dependency exploration
    // This ensures we correctly identify each tier
    const queue = [{id: systemId, level: 0, path: [systemId]}];
    
    while (queue.length > 0) {
        const { id, level, path } = queue.shift();
        
        // Get all systems that depend on this one
        const dependents = dependencyGraph.dependents[id] || [];
        
        dependents.forEach(dependentId => {
            // Skip if already visited or if this is the source system
            if (visitedNodes.has(dependentId) || dependentId === systemId) return;
            visitedNodes.add(dependentId);
            
            // Get system data
            const system = dependencyGraph.nodes[dependentId];
            if (!system) return; // Skip if system data not found
            
            // Determine impact level based on distance from source
            const nextLevel = level + 1;
            const impactLevel = impactLevelMap[nextLevel] || 'quaternary'; // Default to quaternary for deep levels
            
            // Calculate impact score with diminishing factor by level
            const tierFactor = Math.max(0.2, 1 - (nextLevel * 0.2));
            const impact = calculateSystemImpact(system, tierFactor);
            
            // Create the impact data object
            const impactData = {
                ...system,
                impact,
                impactLevel,
                connectionType: getConnectionType(id, dependentId, dependencyGraph),
                sourceNode: id, // Track the direct source of this dependency
                path: [...path, dependentId] // Track the full path for visualization
            };
            
            // Add to appropriate impact array based on level
            if (nextLevel === 1) {
                primaryImpact.push(impactData);
                criticalityScore += impact;
            } else if (nextLevel === 2) {
                secondaryImpact.push(impactData);
                criticalityScore += impact * 0.8;
            } else if (nextLevel === 3) {
                tertiaryImpact.push(impactData);
                criticalityScore += impact * 0.6;
            } else {
                quaternaryImpact.push(impactData);
                criticalityScore += impact * 0.4;
            }
            
            // Add to queue for next level processing
            queue.push({
                id: dependentId,
                level: nextLevel,
                path: [...path, dependentId]
            });
        });
    }
    
    // Log the results for debugging
    console.log("Impact tiers calculated:", {
        primaryImpact,
        secondaryImpact,
        tertiaryImpact,
        quaternaryImpact
    });
    
    // Sort each tier by impact score (descending)
    primaryImpact.sort((a, b) => b.impact - a.impact);
    secondaryImpact.sort((a, b) => b.impact - a.impact);
    tertiaryImpact.sort((a, b) => b.impact - a.impact);
    quaternaryImpact.sort((a, b) => b.impact - a.impact);
    
    return {
        primaryImpact,
        secondaryImpact,
        tertiaryImpact,
        quaternaryImpact,
        criticalityScore,
        recoveryTime: estimateRecoveryTime(primaryImpact, secondaryImpact, tertiaryImpact),
        systemsCount: primaryImpact.length + secondaryImpact.length + tertiaryImpact.length + quaternaryImpact.length,
        userImpact: estimateUserImpact(primaryImpact, criticalityScore),
        businessImpact: estimateBusinessImpact(primaryImpact, secondaryImpact, systemId, dependencyGraph)
    };
}
    
    // Helper function to determine the connection type between two systems
    function getConnectionType(sourceId, targetId, graph) {
        // Check if this is an SSO relationship
        if (graph.ssoRelations[targetId] === sourceId) {
            return 'sso';
        }
        // Check if this is a hosting relationship
        if (graph.hostingRelations[targetId] === sourceId) {
            return 'hosting';
        }
        // Default to direct dependency
        return 'direct';
    }
    
    // Calculate impact score for a system based on its properties
    function calculateSystemImpact(system, tierFactor) {
        // Base impact score
        let impact = 5;
        
        // Factor in system category
        switch (system.category.slug) {
            case 'core':
                impact *= 2.0; // Core systems have highest impact
                break;
            case 'integration':
                impact *= 1.5; // Integration systems have high impact
                break;
            case 'custom':
                impact *= 1.2; // Custom systems have medium impact
                break;
            case 'server':
                impact *= 1.8; // Server systems have high-impact
                break;
            case 'external':
                impact *= 1.0; // External systems have standard impact
                break;
        }
        
        // Adjust by tier factor
        impact *= tierFactor;
        
        // Round to integer
        return Math.round(impact);
    }
    
    // Estimate recovery time based on impact data
    function estimateRecoveryTime(primarySystems, secondaryImpactSystems, tertiaryImpactSystems) {
        // Base recovery time in hours
        let recoveryTime = 2;
        
        // Add time based on number of affected systems
        recoveryTime += primarySystems.length * 2; // 2 hours per primary system
        recoveryTime += secondaryImpactSystems.length * 0.8; // 48 minutes per secondary impact system
        recoveryTime += tertiaryImpactSystems.length * 0.3; // 18 minutes per tertiary impact system
        
        // Add complexity factor based on system types
        const hasCore = primarySystems.some(s => s.category.slug === 'core') || 
                      secondaryImpactSystems.some(s => s.category.slug === 'core');
                      
        const hasExternal = primarySystems.some(s => s.category.slug === 'external') || 
                          secondaryImpactSystems.some(s => s.category.slug === 'external');
        
        const hasServer = primarySystems.some(s => s.category.slug === 'server');
        
        if (hasCore) recoveryTime *= 1.5; // Core systems take 50% longer to recover
        if (hasExternal) recoveryTime *= 1.3; // External systems add 30% to recovery time
        if (hasServer) recoveryTime *= 1.8; // Server failures have longest recovery
        
        // Check for SSO or hosting dependencies in primary impact
        const hasSsoProvider = primarySystems.some(s => s.isSsoProvider);
        const hasHostingProvider = primarySystems.some(s => s.isHostingProvider);
        
        if (hasSsoProvider) recoveryTime *= 1.4; // SSO failures are complex to restore
        if (hasHostingProvider) recoveryTime *= 1.7; // Hosting failures take longest to recover
        
        // Round to nearest 0.5 hour
        return Math.round(recoveryTime * 2) / 2;
    }
    
    // Estimate user impact based on impact data
    function estimateUserImpact(primarySystems, criticalityScore) {
        // Calculate user impact based on primary systems and overall criticality
        const totalImpact = primarySystems.reduce((sum, system) => sum + system.impact, 0);
        
        // Include criticality score in assessment
        const combinedScore = totalImpact + (criticalityScore * 0.2);
        
        if (combinedScore > 50 || primarySystems.some(s => s.isSsoProvider)) return "Critical";
        if (combinedScore > 35) return "High";
        if (combinedScore > 20) return "Medium";
        return "Low";
    }
    
    // Estimate business impact based on impact data
    function estimateBusinessImpact(primarySystems, secondaryImpactSystems, systemId, graph) {
        // Business impact categories
        const categories = {
            "Multiple Departments": 3,
            "Cross-Department": 2,
            "Single Department": 1,
            "Limited": 0
        };
        
        // Default to Limited impact
        let impact = "Limited";
        
        // Check if core systems are affected
        if (primarySystems.some(s => s.category.slug === 'core') || 
            secondaryImpactSystems.length > 5) {
            impact = "Multiple Departments";
        } else if (primarySystems.length > 2 || 
                 secondaryImpactSystems.some(s => s.category.slug === 'core')) {
            impact = "Cross-Department";
        } else if (primarySystems.length > 0) {
            impact = "Single Department";
        }
        
        // Special case for SSO or hosting
        if (graph.ssoRelations[systemId] || 
            graph.hostingRelations[systemId] ||
            primarySystems.some(s => s.isSsoProvider || s.isHostingProvider)) {
            // SSO or hosting failures usually affect multiple departments
            impact = "Multiple Departments";
        }
        
        return impact;
    }
    
    // Update the impact summary on the page
    function updateImpactSummary(impactData) {
        // Update affected systems count
        document.getElementById('total-affected-count').textContent = 
            `${impactData.systemsCount} systems affected`;
        
        // Update the impact progress bar - scale to match the calculated criticality
        const maxCriticality = 100; // Maximum possible criticality score for scaling
        const progressPercentage = Math.min(100, (impactData.criticalityScore / maxCriticality) * 100);
        document.getElementById('impact-progress').style.width = progressPercentage + "%";
        
        // Update impact metrics
        document.getElementById('systems-affected').textContent = impactData.systemsCount;
        document.getElementById('recovery-time').textContent = 
            impactData.recoveryTime <= 24 ? 
            `${impactData.recoveryTime} hours` : 
            `${Math.round(impactData.recoveryTime / 24)} days`;
        document.getElementById('user-impact').textContent = impactData.userImpact;
        document.getElementById('business-impact').textContent = impactData.businessImpact;
    }
    
    // Populate the impacted systems lists
    function populateImpactedSystems(containerId, systems) {
        const container = document.getElementById(containerId);
        
        if (!container) return;
        
        // Clear existing content
        container.innerHTML = '';
        
        if (!systems || systems.length === 0) {
            container.innerHTML = '<div class="p-4 text-sm text-gray-500 text-center">No systems in this impact category</div>';
            return;
        }
        
        // Add each system to the container
        systems.forEach(system => {
            const systemItem = document.createElement('div');
            systemItem.className = 'p-4 hover:bg-gray-50 transition-colors';
            
            let connectionType = '';
            if (system.connectionType === 'sso') {
                connectionType = '<span class="text-xs text-blue-600">SSO</span>';
            } else if (system.connectionType === 'hosting') {
                connectionType = '<span class="text-xs text-purple-600">Hosting</span>';
            }
            
            let sourceInfo = '';
            if (system.sourceNode && system.sourceNode !== {{ system.id }}) {
                // Find the source system name
                const sourceName = dependencyGraph.nodes[system.sourceNode]?.name || 'Unknown System';
                sourceInfo = `<div class="mt-1 text-xs text-gray-500">Dependent on: <a href="#" class="text-blue-600 view-source-btn" data-id="${system.sourceNode}">${sourceName}</a></div>`;
            }
            
            systemItem.innerHTML = `
                <div class="flex justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-900">${system.name}</h3>
                        <div class="flex items-center mt-1 space-x-2">
                            <span class="px-2 py-1 text-xs leading-5 font-semibold rounded-full"
                                style="background-color: ${system.category.color}; color: ${system.category.text_color}">
                                ${system.category.name}
                            </span>
                            ${connectionType ? `<span class="ml-2">${connectionType}</span>` : ''}
                        </div>
                        ${sourceInfo}
                    </div>
                    <div class="flex items-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            Impact: ${system.impact}
                        </span>
                    </div>
                </div>
                <p class="mt-2 text-xs text-gray-500">
                    ${system.vendor && system.vendor !== 'Unknown' ? `Vendor: ${system.vendor}` : ''}
                    ${system.status ? `<br>Status: ${system.status.name}` : ''}
                </p>
                <div class="mt-2 text-right">
                    <a href="#" class="text-xs text-blue-600 hover:text-blue-800 view-system-btn" data-id="${system.id}">
                        View in Graph
                    </a>
                </div>
            `;
            
            // Add click handler for "View in Graph" link
            const viewButton = systemItem.querySelector('.view-system-btn');
            if (viewButton) {
                viewButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    highlightSystemInGraph(system.id);
                });
            }
            
            // Add click handler for "View Source" link if present
            const sourceButton = systemItem.querySelector('.view-source-btn');
            if (sourceButton) {
                sourceButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    highlightSystemInGraph(system.sourceNode);
                });
            }
            
            container.appendChild(systemItem);
        });
    }
    
    // Create the dependency graph visualization
    function createDependencyVisualization(systemId, dependencyGraph, impactData) {
        // Force diagram container to be visible
        const container = document.getElementById('diagram-container');
        const disasterGraph = document.getElementById('disaster-graph');
        
        // Make sure container is visible and has width
        if (container.offsetWidth === 0) {
            const parentWidth = container.parentElement.offsetWidth;
            container.style.width = parentWidth ? (parentWidth + 'px') : '100%';
        }
        
        // Ensure the disaster-graph div takes full width
        disasterGraph.style.width = '100%';
        disasterGraph.style.height = '100%';
        
        // Force a layout calculation
        const forceLayout = container.offsetWidth;
        
        const width = Math.max(container.clientWidth, 800); // Use at least 800px
        const height = Math.max(container.clientHeight, 600); // Use at least 600px
        
        // Clear any existing SVG
        d3.select('#disaster-graph').html('');
        
        // Create SVG element
        const svg = d3.select('#disaster-graph')
            .append('svg')
            .attr('width', width)
            .attr('height', height);
            
        // Add a definitions section for markers (arrowheads)
        const defs = svg.append('defs');
        
        // Add arrow marker for regular connections
        defs.append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#999');
            
        // Add arrow marker for highlighted connections
        defs.append('marker')
            .attr('id', 'arrowhead-highlighted')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#ff5722');
        
        // Create a group for all elements that will be transformed
        const g = svg.append('g');
        
        // Create graph data structure for D3
        const nodes = [];
        const links = [];
        
        // Function to add a system to nodes if not already present
        function addSystemNodeIfNeeded(system) {
            if (!nodes.some(n => n.id === system.id)) {
                nodes.push({
                    id: system.id,
                    name: system.name,
                    category: system.category,
                    status: system.status,
                    vendor: system.vendor,
                    impactLevel: system.impactLevel,
                    isSsoProvider: system.isSsoProvider,
                    isHostingProvider: system.isHostingProvider
                });
            }
        }
        
        // Function to add a link between systems if not already present
        function addSystemLinkIfNeeded(sourceId, targetId, type) {
            if (!links.some(l => 
                (l.source === sourceId && l.target === targetId) || 
                (l.source.id === sourceId && l.target.id === targetId)
            )) {
                links.push({
                    source: sourceId,
                    target: targetId,
                    type: type || 'direct'
                });
            }
        }
        
        // Add the central system (the one being analyzed)
        nodes.push({
            id: systemId,
            name: dependencyGraph.nodes[systemId].name,
            category: dependencyGraph.nodes[systemId].category,
            status: dependencyGraph.nodes[systemId].status,
            vendor: dependencyGraph.nodes[systemId].vendor,
            isMainSystem: true
        });
        
        // Add primary impact systems and their connections
        impactData.primaryImpact.forEach(system => {
            addSystemNodeIfNeeded(system);
            
            // Connect to main system or specified source node
            const sourceId = system.sourceNode || systemId;
            addSystemLinkIfNeeded(sourceId, system.id, system.connectionType);
        });
        
        // Add secondary impact systems and their connections
        impactData.secondaryImpact.forEach(system => {
            addSystemNodeIfNeeded(system);
            
            // Connect to the source node (primary system)
            const sourceId = system.sourceNode || systemId;
            addSystemLinkIfNeeded(sourceId, system.id, system.connectionType);
        });
        
        // Add tertiary impact systems and their connections
        impactData.tertiaryImpact.forEach(system => {
            addSystemNodeIfNeeded(system);
            
            // Connect to the source node (secondary system)
            const sourceId = system.sourceNode || systemId;
            addSystemLinkIfNeeded(sourceId, system.id, system.connectionType);
        });
        
        // Add quaternary impact systems if any
        impactData.quaternaryImpact?.forEach(system => {
            addSystemNodeIfNeeded(system);
            
            // Connect to the source node (tertiary system)
            const sourceId = system.sourceNode || systemId;
            addSystemLinkIfNeeded(sourceId, system.id, system.connectionType);
        });
        
        // Set up force simulation
        const simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(links).id(d => d.id).distance(100))
            .force('charge', d3.forceManyBody().strength(-500))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(30));
        
        // Create links
        const link = g.append('g')
            .selectAll('path')
            .data(links)
            .join('path')
            .attr('class', d => `connection connection-${d.type}`)
            .attr('id', d => `link-${d.source.id || d.source}-${d.target.id || d.target}`)
            .attr('marker-end', 'url(#arrowhead)');
        
        // Create node groups
        const node = g.append('g')
            .selectAll('.node')
            .data(nodes)
            .join('g')
            .attr('class', 'node')
            .attr('id', d => `node-${d.id}`)
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded));
        
        // Add circles to nodes
        node.append('circle')
            .attr('r', d => getNodeRadius(d))
            .attr('fill', d => getNodeFill(d))
            .attr('stroke', d => getNodeStroke(d))
            .attr('class', 'system-node')
            .on('mouseover', handleNodeMouseOver)
            .on('mouseout', handleNodeMouseOut)
            .on('click', handleNodeClick);
        
        // Add text background rectangles
        const textBg = node.append('rect')
            .attr('class', 'label-background')
            .attr('x', -40)
            .attr('y', d => getNodeRadius(d) + 5)
            .attr('width', 80)
            .attr('height', 16)
            .attr('rx', 3);
        
        // Add text labels
        const text = node.append('text')
            .attr('class', d => `system-label ${d.isMainSystem ? 'main-system' : ''}`)
            .attr('y', d => getNodeRadius(d) + 15)
            .text(d => d.name)
            .each(function(d) {
                // Truncate text if too long
                const textElement = d3.select(this);
                let textContent = d.name;
                
                if (textContent.length > 20) {
                    textContent = textContent.substring(0, 17) + '...';
                }
                
                textElement.text(textContent);
                
                // Update background rectangle size based on text width
                const textWidth = this.getComputedTextLength();
                const paddingX = 4;
                
                d3.select(this.parentNode)
                    .select('rect.label-background')
                    .attr('x', -textWidth/2 - paddingX)
                    .attr('width', textWidth + paddingX * 2);
            });
        
        // Set up zoom behavior
        zoomInstance = d3.zoom()
            .scaleExtent([0.1, 8])
            .on('zoom', event => {
                g.attr('transform', event.transform);
            });
            
        svg.call(zoomInstance);
        
        // Tick function for the force simulation
        simulation.on('tick', () => {
            // Keep nodes within the viewport
            nodes.forEach(node => {
                node.x = Math.max(50, Math.min(width - 50, node.x));
                node.y = Math.max(50, Math.min(height - 50, node.y));
            });
            
            // Update link positions
            link.attr('d', d => {
                const sourceNode = d.source.id ? d.source : nodes.find(n => n.id === d.source);
                const targetNode = d.target.id ? d.target : nodes.find(n => n.id === d.target);
                
                // Skip if node data is not available
                if (!sourceNode || !targetNode) return 'M0,0L0,0';
                
                // Calculate path
                const dx = targetNode.x - sourceNode.x;
                const dy = targetNode.y - sourceNode.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                
                // Account for node radius
                const sourceRadius = getNodeRadius(sourceNode);
                const targetRadius = getNodeRadius(targetNode);
                
                // Calculate start and end points adjusting for radius
                const angle = Math.atan2(dy, dx);
                const startX = sourceNode.x + sourceRadius * Math.cos(angle);
                const startY = sourceNode.y + sourceRadius * Math.sin(angle);
                const endX = targetNode.x - targetRadius * Math.cos(angle);
                const endY = targetNode.y - targetRadius * Math.sin(angle);
                
                // Create curved path
                return `M${startX},${startY}A${dr*1.2},${dr*1.2} 0 0,1 ${endX},${endY}`;
            });
            
            // Update node positions
            node.attr('transform', d => `translate(${d.x},${d.y})`);
        });
        
        // Show failure path if requested
        if (showFullPaths) {
            setTimeout(() => {
                showFailurePathsInGraph();
            }, 500);
        }
        
        // Apply optimal layout after a short delay
        setTimeout(optimizeLayout, 200);
        
        // Hide loading overlay
        document.querySelector('.loading-overlay').style.display = 'none';
        
        // Expose simulation for later use
        simulation.nodes(nodes);
        this.simulation = simulation;
        
        // Helper function: Get node radius based on node type
        function getNodeRadius(node) {
            if (node.isMainSystem) return 25;
            if (node.isSsoProvider || node.isHostingProvider) return 22;
            if (node.impactLevel === 'primary') return 20;
            if (node.impactLevel === 'secondary') return 16;
            if (node.impactLevel === 'tertiary') return 14;
            return 12;
        }
        
        // Helper function: Get node fill color based on node type and impact level
        function getNodeFill(node) {
            if (node.isMainSystem) return '#ffd700'; // Gold for main system
            if (node.isSsoProvider) return '#e0f2fe'; // Light blue for SSO provider
            if (node.isHostingProvider) return '#f3e8ff'; // Light purple for hosting provider
            if (node.impactLevel === 'primary') return '#fee2e2'; // Red bg for primary
            if (node.impactLevel === 'secondary') return '#ffedd5'; // Orange bg for secondary
            if (node.impactLevel === 'tertiary') return '#fef9c3'; // Yellow bg for tertiary
            if (node.impactLevel === 'quaternary') return '#e0f2fe'; // Light blue for quaternary
            
            // Default by category
            return node.category?.color || '#f5f5f5';
        }
        
        // Helper function: Get node stroke color
        function getNodeStroke(node) {
            if (node.isMainSystem) return '#ff8c00'; // Orange stroke for main
            if (node.isSsoProvider) return '#0ea5e9'; // Blue stroke for SSO
            if (node.isHostingProvider) return '#a855f7'; // Purple stroke for hosting
            if (node.impactLevel === 'primary') return '#ef4444'; // Red for primary
            if (node.impactLevel === 'secondary') return '#f97316'; // Orange for secondary
            if (node.impactLevel === 'tertiary') return '#eab308'; // Yellow for tertiary
            if (node.impactLevel === 'quaternary') return '#0ea5e9'; // Blue for quaternary
            
            // Default by category
            return node.category?.text_color || '#999';
        }
        
        // Drag handlers
        function dragStarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }
        
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }
        
        function dragEnded(event) {
            if (!event.active) simulation.alphaTarget(0);
            // Keep position fixed to allow manual arrangement
            // event.subject.fx = null;
            // event.subject.fy = null;
        }
        
        // Mouse event handlers
        function handleNodeMouseOver(event, d) {
            // Highlight the node
            d3.select(this).classed('highlighted', true);
            
            // Highlight connected links
            link.each(function(l) {
                if (l.source.id === d.id || l.source === d.id || 
                    l.target.id === d.id || l.target === d.id) {
                    d3.select(this)
                        .classed('connection-highlighted', true)
                        .attr('marker-end', 'url(#arrowhead-highlighted)');
                }
            });
            
            // Show info panel
            showInfoPanel(d);
        }
        
        function handleNodeMouseOut(event, d) {
            // Remove highlight if not clicked
            if (!d3.select(this.parentNode).classed('clicked')) {
                d3.select(this).classed('highlighted', false);
                
                // Reset links
                link.each(function(l) {
                    if (!d3.select(this).classed('failure-path')) {
                        d3.select(this)
                            .classed('connection-highlighted', false)
                            .attr('marker-end', 'url(#arrowhead)');
                    }
                });
                
                // Hide info panel if not clicked
                if (!d3.select('.node.clicked').size()) {
                    hideInfoPanel();
                }
            }
        }
        
        function handleNodeClick(event, d) {
            // Reset all nodes
            node.classed('clicked', false)
                .select('circle')
                .classed('highlighted', false);
                
            // Reset all links
            link.each(function() {
                if (!d3.select(this).classed('failure-path')) {
                    d3.select(this)
                        .classed('connection-highlighted', false)
                        .attr('marker-end', 'url(#arrowhead)');
                }
            });
                
            // Highlight this node
            d3.select(this.parentNode).classed('clicked', true);
            d3.select(this).classed('highlighted', true);
            
            // Highlight connected links
            link.each(function(l) {
                if (l.source.id === d.id || l.source === d.id || 
                    l.target.id === d.id || l.target === d.id) {
                    d3.select(this)
                        .classed('connection-highlighted', true)
                        .attr('marker-end', 'url(#arrowhead-highlighted)');
                }
            });
            
            // Show info panel
            showInfoPanel(d);
            
            // If this is the main system and full paths are enabled, show all paths
            if (d.isMainSystem && showFullPaths) {
                showFailurePathsInGraph();
            }
        }
        
        // Function to highlight a specific system in the graph
        window.highlightSystemInGraph = function(systemId) {
            // Find the node element
            const nodeElement = document.getElementById(`node-${systemId}`);
            if (!nodeElement) return;
            
            // Find the D3 data for this node
            const nodeData = nodes.find(n => n.id === parseInt(systemId));
            if (!nodeData) return;
            
            // Trigger click on the node
            handleNodeClick({}, nodeData);
            
            // Center view on this node
            centerOnNode(nodeData);
        };
    }
    
    // Show complete failure propagation paths
    function showFailurePathsInGraph() {
        // Remove any existing failure paths
        d3.selectAll('.failure-path').remove();
        
        if (!showFullPaths) return;
        
        const svg = d3.select('#disaster-graph svg');
        const g = svg.select('g');
        
        // Helper function to find all paths from the main system to other systems
        function findAllPaths(sourceId, visitedNodes = new Set(), currentPath = []) {
            // Track this node as visited to avoid cycles
            visitedNodes.add(sourceId);
            currentPath.push(sourceId);
            
            const paths = [];
            
            // Get systems dependent on this one
            const dependents = dependencyGraph.dependents[sourceId] || [];
            
            if (dependents.length === 0) {
                // We've reached a leaf node, return the current path
                return [currentPath];
            }
            
            // For each dependent, find all paths from it
            dependents.forEach(dependentId => {
                // Skip if already visited to avoid cycles
                if (visitedNodes.has(dependentId)) return;
                
                // Recursively find paths from this dependent
                const newVisited = new Set(visitedNodes);
                const dependentPaths = findAllPaths(dependentId, newVisited, [...currentPath]);
                
                // Add all paths found from this dependent
                paths.push(...dependentPaths);
            });
            
            // If no dependents found paths, return the current path
            if (paths.length === 0) {
                return [currentPath];
            }
            
            return paths;
        }
        
        // Find all propagation paths from the source system
        const allPaths = findAllPaths({{ system.id }});
        
        // Visualize each path
        allPaths.forEach((path, pathIndex) => {
            // Skip paths with just the source system
            if (path.length <= 1) return;
            
            // Create connections for each segment of the path
            for (let i = 0; i < path.length - 1; i++) {
                const sourceId = path[i];
                const targetId = path[i+1];
                
                // Find the existing path element
                const linkId = `link-${sourceId}-${targetId}`;
                const existingLink = document.getElementById(linkId);
                
                if (!existingLink) continue;
                
                // Get the path data
                const pathData = d3.select(existingLink).attr('d');
                if (!pathData) continue;
                
                // Calculate opacity and width based on path distance from source
                const pathLevel = i;
                const opacity = Math.max(0.4, 1 - (pathLevel * 0.15));
                const width = Math.max(1.5, 4 - (pathLevel * 0.8));
                
                // Create the failure path element
                g.append('path')
                    .attr('d', pathData)
                    .attr('class', 'failure-path')
                    .attr('stroke-opacity', opacity)
                    .attr('stroke-width', width)
                    .attr('data-path-index', pathIndex)
                    .attr('data-path-level', pathLevel);
            }
        });
    }
    
    // Show info panel for a node
    function showInfoPanel(node) {
        const panel = document.getElementById('infoPanel');
        const title = document.getElementById('infoPanelTitle');
        const content = document.getElementById('infoPanelContent');
        
        // Set title
        title.textContent = node.name;
        
        // Build content HTML
        let html = '<div class="space-y-2">';
        
        // Add impact level if applicable
        if (node.impactLevel) {
            let badgeClass;
            let impactText;
            
            switch(node.impactLevel) {
                case 'primary':
                    badgeClass = 'bg-red-100 text-red-800';
                    impactText = 'Primary Impact';
                    break;
                case 'secondary':
                    badgeClass = 'bg-orange-100 text-orange-800';
                    impactText = 'Secondary Impact';
                    break;
                case 'tertiary':
                    badgeClass = 'bg-yellow-100 text-yellow-800';
                    impactText = 'Tertiary Impact';
                    break;
                case 'quaternary':
                    badgeClass = 'bg-blue-100 text-blue-800';
                    impactText = 'Quaternary Impact';
                    break;
                default:
                    badgeClass = 'bg-gray-100 text-gray-800';
                    impactText = 'Unknown Impact';
            }
            
            html += `<div><span class="px-2 py-1 text-xs leading-5 font-semibold rounded-full ${badgeClass}">${impactText}</span></div>`;
        }
        
        // Add category
        if (node.category) {
            html += `<p><strong>Category:</strong> <span style="background-color: ${node.category.color}; color: ${node.category.text_color}; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${node.category.name}</span></p>`;
        }
        
        // Add status
        if (node.status) {
            html += `<p><strong>Status:</strong> <span style="background-color: ${node.status.color}; color: ${node.status.text_color}; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${node.status.name}</span></p>`;
        }
        
        // Add vendor if available
        if (node.vendor && node.vendor !== 'Unknown') {
            html += `<p><strong>Vendor:</strong> ${node.vendor}</p>`;
        }
        
        // Add special role indicators
        if (node.isMainSystem) {
            html += `<p><strong>Role:</strong> <span class="text-amber-600">System Under Analysis</span></p>`;
        } else if (node.isSsoProvider) {
            html += `<p><strong>Role:</strong> <span class="text-blue-600">SSO Provider</span></p>`;
        } else if (node.isHostingProvider) {
            html += `<p><strong>Role:</strong> <span class="text-purple-600">Hosting Provider</span></p>`;
        }
        
        html += `<p class="mt-2"><a href="/systems/${node.id}/" class="text-blue-600 hover:underline">View System Details</a></p>`;
        
        html += '</div>';
        
        // Set content
        content.innerHTML = html;
        
        // Show panel
        panel.style.display = 'block';
    }
    
    // Hide info panel
    function hideInfoPanel() {
        const panel = document.getElementById('infoPanel');
        panel.style.display = 'none';
    }
    
    // Reset view
    function resetView() {
        // Clear any highlighting
        d3.selectAll('.node').classed('clicked', false);
        d3.selectAll('.system-node').classed('highlighted', false);
        d3.selectAll('.connection')
            .classed('connection-highlighted', false)
            .attr('marker-end', 'url(#arrowhead)');
        
        // Remove failure paths
        d3.selectAll('.failure-path').remove();
        
        // Reset simulation
        if (simulation) {
            simulation.alpha(0.3).restart();
        }
        
        // Reset zoom
        const svg = d3.select('#disaster-graph svg');
        svg.transition().duration(750).call(
            zoomInstance.transform, d3.zoomIdentity
        );
        
        // Hide info panel
        hideInfoPanel();
    }
    
    // Apply optimal layout
    function optimizeLayout() {
        if (!simulation) return;
        
        // Find the central node
        const centralNode = simulation.nodes().find(n => n.isMainSystem);
        if (!centralNode) return;
        
        // Place central node in the middle
        centralNode.fx = d3.select('#disaster-graph svg').attr('width') / 2;
        centralNode.fy = d3.select('#disaster-graph svg').attr('height') / 2;
        
        // Arrange primary nodes in a circle around central node
        const primaryNodes = simulation.nodes().filter(n => n.impactLevel === 'primary');
        const primaryRadius = Math.max(150, 80 + primaryNodes.length * 10);
        
        primaryNodes.forEach((node, i) => {
            const angle = (i / primaryNodes.length) * 2 * Math.PI;
            node.fx = centralNode.fx + primaryRadius * Math.cos(angle);
            node.fy = centralNode.fy + primaryRadius * Math.sin(angle);
        });
        
        // Arrange secondary impact nodes in a wider circle
        const secondaryNodes = simulation.nodes().filter(n => n.impactLevel === 'secondary');
        const secondaryRadius = primaryRadius + 100;
        
        secondaryNodes.forEach((node, i) => {
            const angle = (i / secondaryNodes.length) * 2 * Math.PI;
            node.fx = centralNode.fx + secondaryRadius * Math.cos(angle);
            node.fy = centralNode.fy + secondaryRadius * Math.sin(angle);
        });
        
        // Arrange tertiary impact nodes in the outermost circle
        const tertiaryNodes = simulation.nodes().filter(n => n.impactLevel === 'tertiary');
        const tertiaryRadius = secondaryRadius + 100;
        
        tertiaryNodes.forEach((node, i) => {
            const angle = (i / tertiaryNodes.length) * 2 * Math.PI;
            node.fx = centralNode.fx + tertiaryRadius * Math.cos(angle);
            node.fy = centralNode.fy + tertiaryRadius * Math.sin(angle);
        });
        
        // Arrange quaternary nodes in the furthest circle
        const quaternaryNodes = simulation.nodes().filter(n => n.impactLevel === 'quaternary');
        const quaternaryRadius = tertiaryRadius + 100;
        
        quaternaryNodes.forEach((node, i) => {
            const angle = (i / quaternaryNodes.length) * 2 * Math.PI;
            node.fx = centralNode.fx + quaternaryRadius * Math.cos(angle);
            node.fy = centralNode.fy + quaternaryRadius * Math.sin(angle);
        });
        
        // Restart simulation to apply changes
        simulation.alpha(0.3).restart();
        
        // Fit all nodes into view
        setTimeout(fitAllNodes, 500);
    }
    
    // Toggle showing full failure paths
    function toggleFullPath() {
        showFullPaths = !showFullPaths;
        
        // Update button state
        const button = document.getElementById('showFullPathButton');
        if (showFullPaths) {
            button.classList.add('active');
            showFailurePathsInGraph();
        } else {
            button.classList.remove('active');
            d3.selectAll('.failure-path').remove();
        }
    }
    
    // Toggle hiding intermediate nodes
    function toggleIntermediate() {
        hideIntermediateNodes = !hideIntermediateNodes;
        
        // Update button state
        const button = document.getElementById('toggleIntermediateButton');
        if (hideIntermediateNodes) {
            button.classList.add('active');
            
            // Hide tertiary and quaternary impact nodes
            d3.selectAll('.node').each(function(d) {
                if (d && (d.impactLevel === 'tertiary' || d.impactLevel === 'quaternary')) {
                    d3.select(this).style('opacity', 0.2);
                }
            });
            
            // Hide links to tertiary and quaternary impact nodes
            d3.selectAll('.connection').each(function(d) {
                if (d && d.target && (d.target.impactLevel === 'tertiary' || d.target.impactLevel === 'quaternary')) {
                    d3.select(this).style('opacity', 0.2);
                }
            });
        } else {
            button.classList.remove('active');
            
            // Show all nodes
            d3.selectAll('.node').style('opacity', 1);
            
            // Show all links
            d3.selectAll('.connection').style('opacity', 0.6);
        }
    }
    
    // Toggle showing hosting dependencies
    function toggleHosting() {
        showHostingDependencies = !showHostingDependencies;
        
        // Update button state
        const button = document.getElementById('toggleHostingButton');
        if (showHostingDependencies) {
            button.classList.add('active');
            
            // Show hosting links
            d3.selectAll('.connection-hosting').style('opacity', 0.6);
            
            // Show hosting provider nodes
            d3.selectAll('.node').each(function(d) {
                if (d && d.isHostingProvider) {
                    d3.select(this).style('opacity', 1);
                }
            });
        } else {
            button.classList.remove('active');
            
            // Hide hosting links
            d3.selectAll('.connection-hosting').style('opacity', 0.2);
            
            // Fade hosting provider nodes (unless highlighted)
            d3.selectAll('.node').each(function(d) {
                if (d && d.isHostingProvider && !d3.select(this).classed('clicked')) {
                    d3.select(this).style('opacity', 0.3);
                }
            });
        }
    }
    
    // Toggle showing SSO dependencies
    function toggleSso() {
        showSsoDependencies = !showSsoDependencies;
        
        // Update button state
        const button = document.getElementById('toggleSsoButton');
        if (showSsoDependencies) {
            button.classList.add('active');
            
            // Show SSO links
            d3.selectAll('.connection-sso').style('opacity', 0.6);
            
            // Show SSO provider nodes
            d3.selectAll('.node').each(function(d) {
                if (d && d.isSsoProvider) {
                    d3.select(this).style('opacity', 1);
                }
            });
        } else {
            button.classList.remove('active');
            
            // Hide SSO links
            d3.selectAll('.connection-sso').style('opacity', 0.2);
            
            // Fade SSO provider nodes (unless highlighted)
            d3.selectAll('.node').each(function(d) {
                if (d && d.isSsoProvider && !d3.select(this).classed('clicked')) {
                    d3.select(this).style('opacity', 0.3);
                }
            });
        }
    }
    
    // Center on a specific node
    function centerOnNode(node) {
        const svg = d3.select('#disaster-graph svg');
        const width = parseInt(svg.attr('width'));
        const height = parseInt(svg.attr('height'));
        
        const scale = 1.5; // Zoom in a bit
        const transform = d3.zoomIdentity
            .translate(width/2 - node.x * scale, height/2 - node.y * scale)
            .scale(scale);
        
        // Apply transform with transition
        svg.transition().duration(750).call(
            zoomInstance.transform, transform
        );
    }
    
    // Fit all nodes within view
    function fitAllNodes() {
        if (!simulation) return;
        
        const svg = d3.select('#disaster-graph svg');
        const width = parseInt(svg.attr('width'));
        const height = parseInt(svg.attr('height'));
        
        // Get bounds of all nodes
        let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
        
        simulation.nodes().forEach(node => {
            minX = Math.min(minX, node.x || 0);
            maxX = Math.max(maxX, node.x || 0);
            minY = Math.min(minY, node.y || 0);
            maxY = Math.max(maxY, node.y || 0);
        });
        
        // Add padding
        const padding = 80;
        minX -= padding;
        minY -= padding;
        maxX += padding;
        maxY += padding;
        
        // Calculate scale to fit
        const scale = Math.min(
            width / (maxX - minX), 
            height / (maxY - minY),
            1.5 // Maximum scale
        );
        
        // Calculate center of the bounding box
        const centerX = (minX + maxX) / 2;
        const centerY = (minY + maxY) / 2;
        
        // Create transformation to center and scale the view
        const transform = d3.zoomIdentity
            .translate(width/2 - centerX * scale, height/2 - centerY * scale)
            .scale(scale);
        
        // Apply transform with transition
        svg.transition().duration(750).call(
            zoomInstance.transform, transform
        );
    }
    
    // Zoom in
    function zoomIn() {
        const svg = d3.select('#disaster-graph svg');
        const currentTransform = d3.zoomTransform(svg.node());
        
        svg.transition().duration(300).call(
            zoomInstance.scaleBy, 1.5
        );
    }
    
    // Zoom out
    function zoomOut() {
        const svg = d3.select('#disaster-graph svg');
        
        svg.transition().duration(300).call(
            zoomInstance.scaleBy, 0.667
        );
    }
    
    // Recovery Step Management
    
    // Function to open recovery step modal for a new step
    function openRecoveryStepModal(stepData = null) {
        const modal = document.getElementById('recoveryStepModal');
        const form = document.getElementById('recoveryStepForm');
        const title = document.getElementById('stepModalTitle');
        
        // Reset form
        form.reset();
        
        // Set title and fields based on whether editing or adding
        if (stepData) {
            title.textContent = 'Edit Recovery Step';
            document.getElementById('stepId').value = stepData.id;
            document.getElementById('stepTitle').value = stepData.title;
            document.getElementById('stepDescription').value = stepData.description;
            document.getElementById('responsibleTeam').value = stepData.responsible_team || '';
            document.getElementById('estimatedTime').value = stepData.estimated_time || '';
        } else {
            title.textContent = 'Add Recovery Step';
            document.getElementById('stepId').value = '';
        }
        
        // Show modal
        modal.classList.remove('hidden');
    }
    
    // Function to close recovery step modal
    function closeRecoveryStepModal() {
        document.getElementById('recoveryStepModal').classList.add('hidden');
    }
    
    // Function to edit a recovery step
    function editRecoveryStep(stepId) {
        // Fetch step data via API
        fetch(`/systems/recovery-step/${stepId}/`)
            .then(response => response.json())
            .then(data => {
                openRecoveryStepModal(data);
            })
            .catch(error => {
                console.error('Error fetching recovery step:', error);
            });
    }
    
    // Function to confirm deletion of a recovery step
    function confirmDeleteStep(stepId) {
        document.getElementById('deleteStepId').value = stepId;
        
        // Update form action with the correct step ID
        const form = document.getElementById('deleteStepForm');
        form.action = form.action.replace(/\/\d+\/$/, `/${stepId}/`);
        
        document.getElementById('deleteStepModal').classList.remove('hidden');
    }
    
    // Function to move a recovery step up or down
    function moveRecoveryStep(stepId, direction) {
        const data = {
            step_id: stepId,
            direction: direction
        };
        
        fetch(`/systems/{{ system.id }}/move-recovery-step/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                // Reload the page to reflect changes
                window.location.reload();
            } else {
                console.error('Error moving recovery step');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
});
</script>
{% endblock %}